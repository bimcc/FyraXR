var e=(e,t,s)=>new Promise((n,i)=>{var o=e=>{try{r(s.next(e))}catch(t){i(t)}},a=e=>{try{r(s.throw(e))}catch(t){i(t)}},r=e=>e.done?n(e.value):Promise.resolve(e.value).then(o,a);r((s=s.apply(e,t)).next())});import{U as t,ab as s,aj as n,am as i,W as o,an as a,ao as r,ap as l,aq as d,D as c,ar as h,as as u,E as p,at as m}from"./three-CpL7CGyr.js";import{T as g}from"./3d-tiles-CBwan3Gz.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class y extends EventTarget{constructor(e,t,s){super(),this.renderer=e,this.scene=t,this.camera=s,this.session=null,this.isSupported=!1,this.checkARSupport()}checkARSupport(){return e(this,null,function*(){"xr"in navigator?(this.isSupported=yield navigator.xr.isSessionSupported("immersive-ar"),console.log("AR Support:",this.isSupported)):console.log("WebXR not supported")})}startARSession(){return e(this,null,function*(){if(!this.isSupported)throw new Error("AR not supported");try{this.session=yield navigator.xr.requestSession("immersive-ar",{requiredFeatures:["local-floor"],optionalFeatures:["dom-overlay"],domOverlay:{root:document.getElementById("ui-overlay")}}),yield this.renderer.xr.setSession(this.session),this.dispatchEvent(new Event("sessionstart"))}catch(e){throw console.error("Failed to start AR session:",e),e}})}endARSession(){this.session&&(this.session.end(),this.session=null,this.dispatchEvent(new Event("sessionend")))}}class w{constructor(){this.calibrationData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},this.loadCalibration()}setPosition(e,t,s){this.calibrationData.position={x:e,y:t,z:s}}setRotation(e,t,s){this.calibrationData.rotation={x:e,y:t,z:s}}setScale(e,t,s){this.calibrationData.scale={x:e,y:t,z:s}}getCalibrationData(){return this.calibrationData}saveCalibration(){localStorage.setItem("fyraxr-calibration",JSON.stringify(this.calibrationData)),console.log("Calibration saved:",this.calibrationData)}loadCalibration(){const e=localStorage.getItem("fyraxr-calibration");e&&(this.calibrationData=JSON.parse(e),console.log("Calibration loaded:",this.calibrationData))}resetCalibration(){this.calibrationData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},this.saveCalibration()}}class f{constructor(e){this.app=e,this.isCollapsed=!1,this.setupEventListeners(),this.setupPanelCollapse()}setupEventListeners(){const e=document.getElementById("ar-button");e&&e.addEventListener("click",()=>this.toggleAR());const t=document.getElementById("calibrate-button");t&&t.addEventListener("click",()=>this.toggleCalibration());const s=document.getElementById("reset-position");s&&s.addEventListener("click",()=>this.resetPosition());const n=document.getElementById("save-calibration");n&&n.addEventListener("click",()=>this.saveCalibration());const i=document.getElementById("close-calibration");i&&i.addEventListener("click",()=>this.closeCalibration());const o=document.getElementById("apply-calibration");o&&o.addEventListener("click",()=>this.applyCalibration());const a=document.getElementById("opacity-slider");a&&a.addEventListener("input",e=>this.updateOpacity(e.target.value));const r=document.getElementById("scale-slider");r&&r.addEventListener("input",e=>this.updateScale(e.target.value)),this.setupCalibrationSliders()}setupPanelCollapse(){const e=document.getElementById("collapse-btn"),t=document.getElementById("panel-content"),s=document.getElementById("panel-header");e&&t&&(e.addEventListener("click",e=>{e.stopPropagation(),this.togglePanelCollapse()}),s.addEventListener("click",()=>{this.togglePanelCollapse()}))}togglePanelCollapse(){const e=document.getElementById("collapse-btn"),t=document.getElementById("panel-content");this.isCollapsed=!this.isCollapsed,this.isCollapsed?(t.classList.add("collapsed"),e.textContent="+"):(t.classList.remove("collapsed"),e.textContent="−")}setupCalibrationSliders(){[{id:"offset-x",valueId:"offset-x-value"},{id:"offset-y",valueId:"offset-y-value"},{id:"offset-z",valueId:"offset-z-value"},{id:"rotation-y",valueId:"rotation-y-value",suffix:"°"}].forEach(e=>{const t=document.getElementById(e.id),s=document.getElementById(e.valueId);t&&s&&t.addEventListener("input",t=>{const n=t.target.value;s.textContent=n+(e.suffix||"")})})}toggleAR(){return e(this,null,function*(){try{this.app.isARActive?this.app.arManager.endARSession():yield this.app.arManager.startARSession()}catch(e){console.error("AR toggle failed:",e),this.updateARStatus("AR启动失败")}})}toggleCalibration(){const e=document.getElementById("calibration-panel");e&&(e.style.display="none"===e.style.display?"block":"none")}closeCalibration(){const e=document.getElementById("calibration-panel");e&&(e.style.display="none")}applyCalibration(){const e=parseFloat(document.getElementById("offset-x").value),t=parseFloat(document.getElementById("offset-y").value),s=parseFloat(document.getElementById("offset-z").value),n=parseFloat(document.getElementById("rotation-y").value);this.app.calibrationManager.applyCalibration({offset:{x:e,y:t,z:s},rotation:{y:n}}),this.updateARStatus("标定已应用")}resetPosition(){this.app.calibrationManager.resetCalibration(),this.updateARStatus("位置已重置"),document.getElementById("offset-x").value=0,document.getElementById("offset-y").value=0,document.getElementById("offset-z").value=0,document.getElementById("rotation-y").value=0,document.getElementById("offset-x-value").textContent="0",document.getElementById("offset-y-value").textContent="0",document.getElementById("offset-z-value").textContent="0",document.getElementById("rotation-y-value").textContent="0°"}saveCalibration(){this.app.calibrationManager.saveCalibration(),this.updateARStatus("标定已保存")}updateOpacity(e){const t=document.getElementById("opacity-value");t&&(t.textContent=e),this.app.tilesManager&&this.app.tilesManager.setOpacity&&this.app.tilesManager.setOpacity(parseFloat(e))}updateScale(e){const t=document.getElementById("scale-value");t&&(t.textContent=e),this.app.tilesManager&&this.app.tilesManager.scaleModel&&this.app.tilesManager.scaleModel(parseFloat(e))}updateARStatus(e){const t=document.getElementById("ar-status");t&&(t.textContent=e)}updateTilesStatus(e){const t=document.getElementById("tiles-status");t&&(t.textContent=e)}showPanel(){const e=document.getElementById("control-panel");e&&(e.style.display="block")}hidePanel(){const e=document.getElementById("control-panel");e&&(e.style.display="none")}}class v{constructor(e,s,n){this.scene=e,this.camera=s,this.renderer=n,this.tilesRenderer=null,this.group=new t,this.scene.add(this.group)}loadTileset(t){return e(this,null,function*(){console.log("开始加载tileset:",t);try{const s=t=>e(this,null,function*(){try{const e=yield fetch(t,{method:"HEAD",cache:"no-cache"});if(e.ok){console.log(`✅ 资源可访问: ${t}`);let e=window.TilesRenderer||g;return new e(t)}return console.warn(`❌ 资源不可访问 (${e.status}): ${t}`),null}catch(e){return console.warn(`❌ 检查资源失败: ${t}`,e),null}});if(this.tilesRenderer=yield s(t),!this.tilesRenderer){console.log("直接URL加载失败，尝试其他路径...");const e=window.location.hostname.includes("github.io")?"/FyraXR":"",t=["./models/mj/tileset.json","../models/mj/tileset.json",`${window.location.pathname.includes("/FyraXR/")?"/FyraXR/":"/"}models/mj/tileset.json`,"/FyraXR/models/mj/tileset.json",`${e}/models/mj/tileset.json`,`${window.location.origin}${e}/models/mj/tileset.json`];for(const n of t)if(console.log(`尝试备用路径: ${n}`),this.tilesRenderer=yield s(n),this.tilesRenderer){console.log(`✅ 成功使用备用路径: ${n}`);break}if(!this.tilesRenderer)throw new Error("所有路径尝试失败")}return this.tilesRenderer.setCamera(this.camera),this.tilesRenderer.setResolutionFromRenderer(this.camera,this.renderer),this.tilesRenderer.addEventListener("load-tile-set",()=>{console.log("Tileset加载完成!"),this.optimizeModelView()}),this.tilesRenderer.addEventListener("load-tile-set-failed",e=>{console.error("Tileset加载失败:",e)}),this.group.add(this.tilesRenderer.group),console.log("TilesRenderer已创建并添加到场景"),Promise.resolve()}catch(s){throw console.error("创建TilesRenderer时出错:",s),s}})}optimizeModelView(){if(!this.tilesRenderer)return;const e=new s;this.tilesRenderer.getBoundingSphere(e),console.log("模型边界球:",e),this.tilesRenderer.group.position.copy(e.center).multiplyScalar(-1);const t=e.radius,n=Math.max(t,50),i=3.5*n,o=2*n,a=2*n;this.camera.position.set(a,o,i),this.camera.lookAt(0,0,0),this.camera.near=.01*n,this.camera.far=100*n,this.camera.updateProjectionMatrix(),console.log("相机位置已优化:",this.camera.position),console.log("模型半径:",t,"有效半径:",n),console.log("相机距离:",i)}update(){this.tilesRenderer&&(this.camera.updateMatrixWorld(),this.tilesRenderer.update())}centerCamera(){this.optimizeModelView(),console.log("相机已手动重新居中到模型")}scaleModel(e){this.tilesRenderer&&(this.tilesRenderer.group.scale.setScalar(e),console.log("模型缩放因子设置为:",e))}resetView(){this.tilesRenderer&&(this.tilesRenderer.group.scale.setScalar(1),this.optimizeModelView(),console.log("视图已重置"))}}void 0===window.THREE&&(window.THREE=n),void 0===window.TilesRenderer&&(window.TilesRenderer=g);const R=new class{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.arManager=null,this.calibrationManager=null,this.uiController=null,this.tilesManager=null,this.isARActive=!1,this.animationId=null,this.init()}init(){return e(this,null,function*(){try{this.setupThreeJS(),this.setupManagers(),this.setupEventListeners(),yield this.loadDefaultTileset(),this.startRenderLoop(),console.log("FyraXR应用初始化完成")}catch(e){console.error("应用初始化失败:",e)}})}setupThreeJS(){this.scene=new i,this.camera=new o(75,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,5,10),this.renderer=new a({antialias:!0,alpha:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=r,this.renderer.xr.enabled=!0,document.getElementById("container").appendChild(this.renderer.domElement),this.controls=new l(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.maxPolarAngle=Math.PI;const e=new d(16777215,.6);this.scene.add(e);const t=new c(16777215,.8);t.position.set(50,50,50),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,this.scene.add(t)}setupManagers(){this.arManager=new y(this.renderer,this.scene,this.camera),this.calibrationManager=new w,this.uiController=new f(this),this.tilesManager=new v(this.scene,this.camera,this.renderer)}setupEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),this.arManager.addEventListener("sessionstart",()=>{this.isARActive=!0,this.uiController.updateARStatus("AR已启动"),console.log("AR会话已启动")}),this.arManager.addEventListener("sessionend",()=>{this.isARActive=!1,this.uiController.updateARStatus("AR已结束"),console.log("AR会话已结束")})}loadDefaultTileset(){return e(this,null,function*(){try{const e=window.location.pathname.includes("/FyraXR/")?"/FyraXR":"";return console.log("🌐 Tileset加载基础路径:",e),yield this.tilesManager.loadTileset(`${e}/models/mj/tileset.json`),this.uiController.updateTilesStatus("3D Tiles加载完成"),void console.log("3D Tiles模型加载成功!")}catch(e){console.warn("所有tileset加载尝试失败:",e),this.createExampleGeometry(),this.uiController.updateTilesStatus("使用示例几何体 (模型加载失败)")}})}createExampleGeometry(){const e=new h(2,2,2),t=new u({color:65280,transparent:!0,opacity:.8}),s=new p(e,t);s.position.set(0,1,-5),this.scene.add(s);for(let n=0;n<5;n++){const e=new m(.5,16,16),t=new u({color:16777215*Math.random(),transparent:!0,opacity:.7}),s=new p(e,t);s.position.set(10*(Math.random()-.5),3*Math.random(),5*(Math.random()-.5)-5),this.scene.add(s)}}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.controls&&this.controls.update()}startRenderLoop(){const e=()=>{this.animationId=this.renderer.setAnimationLoop(e),this.controls&&!this.isARActive&&this.controls.update(),this.tilesManager.tilesRenderer&&(this.camera.updateMatrixWorld(),this.tilesManager.tilesRenderer.update()),this.renderer.render(this.scene,this.camera)};e()}startAR(){return e(this,null,function*(){try{this.controls&&(this.controls.enabled=!1),yield this.arManager.startARSession()}catch(e){console.error("启动AR失败:",e),alert("启动AR失败: "+e.message),this.controls&&(this.controls.enabled=!0)}})}stopAR(){this.arManager.stopARSession(),this.controls&&(this.controls.enabled=!0)}applyCalibration(e){this.calibrationManager.applyCalibration(this.scene,e)}resetPosition(){this.calibrationManager.resetPosition(this.scene)}};window.fyraxrApp=R;
