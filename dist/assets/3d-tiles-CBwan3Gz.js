var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,o=Math.pow,a=(t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n,l=(e,t,s)=>new Promise((n,r)=>{var i=e=>{try{a(s.next(e))}catch(t){r(t)}},o=e=>{try{a(s.throw(e))}catch(t){r(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,o);a((s=s.apply(e,t)).next())});import{T as c,a as h,b as u,L as d,c as p,F as m,M as f,V as g,C as _,d as T,S as y,e as b,P as A,D as x,f as w,g as R,I as E,Q as v,h as S,O as L,i as C,j as P,B as M,k as I,l as O,N as F,m as N,n as U,o as k,p as D,R as B,q as H,r as V,s as j,t as G,u as z,v as K,w as W,x as q,y as X,z as Y,A as Q,E as $,G as J,H as Z,J as ee,K as te,U as se,W as ne,X as re,Y as ie,Z as oe,_ as ae,$ as le,a0 as ce,a1 as he,a2 as ue,a3 as de,a4 as pe,a5 as me,a6 as fe,a7 as ge,a8 as _e,a9 as Te,aa as ye,ab as be,ac as Ae,ad as xe,ae as we,af as Re,ag as Ee,ah as ve,ai as Se,aj as Le,ak as Ce,al as Pe}from"./three-CpL7CGyr.js";function Me(e){if(!e)return null;const t=e.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),s=t.lastIndexOf(".");return-1===s?null:t.substring(s+1)||null}const Ie=o(2,30);class Oe{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){1===e.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*Ie,this.maxBytesSize=.4*Ie,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)||0}setMemoryUsage(e,t){const{bytesMap:s,itemSet:n}=this;n.has(e)&&(this.cachedBytes-=s.get(e)||0,s.set(e,t),this.cachedBytes+=t)}add(e,t){const s=this.itemSet;if(s.has(e))return!1;if(this.isFull())return!1;const n=this.usedSet,r=this.itemList,i=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),i.set(e,t),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,i=this.callbacks,o=this.loadedSet;if(s.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),i.get(e)(e);const a=n.indexOf(e);return n.splice(a,1),t.delete(e),s.delete(e),i.delete(e),o.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(!0===t?n.add(e):n.delete(e))}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:i,loadedSet:o,callbacks:a,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,u=n.length-i.size,d=n.length-o.size,p=Math.max(Math.min(n.length-t,u),0),m=this.cachedBytes-c,f=this.unloadPriorityCallback||this.defaultPriorityCallback;let g=!1;const _=p>0&&u>0||d&&n.length>s;if(u&&this.cachedBytes>c||d&&this.cachedBytes>h||_){n.sort((e,t)=>{const s=i.has(e);if(s===i.has(t)){const s=o.has(e);return s===o.has(t)?-f(e,t):s?1:-1}return s?1:-1});const d=Math.max(t*e,p*e),_=Math.ceil(Math.min(d,u,p)),T=Math.max(e*m,e*c),y=Math.min(T,m);let b=0,A=0;for(;this.cachedBytes-A>h||n.length-b>s;){const e=n[b],t=l.get(e)||0;if(i.has(e)&&o.has(e)||this.cachedBytes-A-t<h&&n.length-b<=s)break;A+=t,b++}for(;A<y||b<_;){const e=n[b],t=l.get(e)||0;if(i.has(e)||this.cachedBytes-A-t<c&&b>=_)break;A+=t,b++}n.splice(0,b).forEach(e=>{this.cachedBytes-=l.get(e)||0,a.get(e)(e),l.delete(e),r.delete(e),a.delete(e),o.delete(e),i.delete(e)}),g=b<p||A<m&&b<u,g=g&&b>0}g&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class Fe{get running(){return 0!==this.items.length||0!==this.currJobs}constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback;this.items.sort(e)}has(e){return this.callbacks.has(e)}add(e,t){const s={callback:t,reject:null,resolve:null,promise:null};return s.promise=new Promise((t,n)=>{const r=this.items,i=this.callbacks;s.resolve=t,s.reject=n,r.push(e),i.set(e,s),this.autoUpdate&&this.scheduleJobRun()}),s.promise}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);if(-1!==n){const r=s.get(e);r.promise.catch(()=>{}),r.reject(new Error("PriorityQueue: Item removed.")),t.splice(n,1),s.delete(e)}}removeByFilter(e){const{items:t}=this;for(let s=0;s<t.length;s++){const n=t[s];e(n)&&this.remove(n)}}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=0;const r=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&e.length>0&&n<s;){this.currJobs++,n++;const s=e.pop(),{callback:o,resolve:a,reject:l}=t.get(s);let c;t.delete(s);try{c=o(s)}catch(i){l(i),r()}c instanceof Promise?c.then(a).catch(l).finally(r):(a(c),r())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const Ne=-1,Ue=6378137,ke={inView:!1,error:1/0,distanceFromCamera:1/0};function De(e){return 3===e||e===Ne}function Be(e,t){return e.__lastFrameVisited===t&&e.__used}function He(e){return e.__childrenProcessed===e.children.length}function Ve(e,t){e.__lastFrameVisited!==t.frameCount&&(e.__lastFrameVisited=t.frameCount,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,t.calculateTileViewError(e,ke),e.__inFrustum=ke.inView,e.__error=ke.error,e.__distanceFromCamera=ke.distanceFromCamera)}function je(e,t){if(t.ensureChildrenArePreprocessed(e),Ve(e,t),ze(e,t),!e.__hasRenderableContent&&He(e)){const s=e.children;for(let e=0,n=s.length;e<n;e++)je(s[e],t)}}function Ge(e,t){if(t.ensureChildrenArePreprocessed(e),Be(e,t.frameCount)&&(e.__hasContent&&0===e.__loadingState&&!t.lruCache.isFull()&&t.queueTileForDownload(e),He(e))){const s=e.children;for(let e=0,n=s.length;e<n;e++)Ge(s[e],t)}}function ze(e,t){e.__used||(e.__used=!0,t.markTileUsed(e),t.stats.used++,!0===e.__inFrustum&&t.stats.inFrustum++)}function Ke(e,t){if(t.ensureChildrenArePreprocessed(e),Ve(e,t),!e.__inFrustum)return;if(!function(e,t){return!(e.__error<=t.errorTarget||t.maxDepth>0&&e.__depth+1>=t.maxDepth||!He(e))}(e,t))return void ze(e,t);let s=!1,n=!1;const r=e.children;for(let i=0,o=r.length;i<o;i++){const e=r[i];Ke(e,t),s=s||Be(e,t.frameCount),n=n||e.__inFrustum}if(ze(e,t),s&&"REPLACE"===e.refine)for(let i=0,o=r.length;i<o;i++){je(r[i],t)}}function We(e,t){const s=t.frameCount;if(!Be(e,s))return;const n=e.children;let r=!1;for(let i=0,o=n.length;i<o;i++){const e=n[i];r=r||Be(e,s)}if(r){let r=!1,i=!0;for(let e=0,o=n.length;e<o;e++){const o=n[e];if(We(o,t),r=r||o.__wasSetVisible||o.__childrenWereVisible,Be(o,s)){const e=o.__allChildrenLoaded||o.__hasRenderableContent&&De(o.__loadingState)||!o.__hasContent&&0===o.children.length||o.__hasUnrenderableContent&&o.__loadingState===Ne;i=i&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=i}else e.__isLeaf=!0}function qe(e,t){const s=t.stats;if(!Be(e,t.frameCount))return;const n=t.lruCache;if(e.__isLeaf)return void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++):!n.isFull()&&e.__hasContent&&t.queueTileForDownload(e));const r=e.children,i=e.__hasContent,o=De(e.__loadingState)&&i,a=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=a,c=e.__childrenWereVisible,h=e.__allChildrenLoaded;if((l||"ADD"===e.refine)&&!o&&!n.isFull()&&i&&t.queueTileForDownload(e),(l&&!h&&!c&&o||"ADD"===e.refine&&o)&&(e.__inFrustum&&(e.__visible=!0,s.visible++),e.__active=!0,s.active++),"REPLACE"===e.refine&&l&&!h)for(let u=0,d=r.length;u<d;u++){const e=r[u];Be(e,t.frameCount)&&Ge(e,t)}else for(let u=0,d=r.length;u<d;u++)qe(r[u],t)}function Xe(e,t){const s=Be(e,t.frameCount);if(s||e.__usedLastFrame){let n=!1,r=!1;s?(n=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible):Ve(e,t),e.__hasRenderableContent&&3===e.__loadingState&&(e.__wasSetActive!==n&&t.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,n)),e.__wasSetVisible!==r&&t.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,r))),e.__wasSetActive=n,e.__wasSetVisible=r,e.__usedLastFrame=s;const i=e.children;for(let e=0,s=i.length;e<s;e++){Xe(i[e],t)}}}const Ye=Symbol("PLUGIN_REGISTERED"),Qe=(e,t)=>{const s=e.priority||0,n=t.priority||0;return s!==n?s>n?1:-1:e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0},$e=(e,t)=>{const s=e.priority||0,n=t.priority||0;return s!==n?s>n?1:-1:e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?1:-1:e.__loadingState!==t.__loadingState?e.__loadingState>t.__loadingState?-1:1:e.__lastFrameVisited!==t.__lastFrameVisited?e.__lastFrameVisited>t.__lastFrameVisited?-1:1:e.__hasUnrenderableContent!==t.__hasUnrenderableContent?e.__hasUnrenderableContent?-1:1:e.__error!==t.__error?e.__error>t.__error?-1:1:0};class Je{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const{stats:e,isLoading:t}=this,s=e.downloading+e.parsing,n=e.inCacheSinceLoad+(t?1:0);return 0===n?1:1-s/n}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=0,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set,this.isLoading=!1;const t=new Oe;t.unloadPriorityCallback=$e;const s=new Fe;s.maxJobs=25,s.priorityCallback=Qe;const n=new Fe;n.maxJobs=5,n.priorityCallback=Qe;const r=new Fe;r.maxJobs=25,r.priorityCallback=Qe,r.log=!0,this.processedTiles=new WeakSet,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.processNodeQueue=r,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this._dispatchNeedsUpdateEvent=function(e){let t=null;return()=>{null===t&&(t=requestAnimationFrame(()=>{t=null,e()}))}}(()=>{this.dispatchEvent({type:"needs-update"})}),this.errorTarget=16,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(!0===e[Ye])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let n=t.length;for(let r=0;r<t.length;r++){if((t[r].priority||0)>s){n=r;break}}t.splice(n,0,e),e[Ye]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(t=>t.name===e)||null}traverse(e,t,s=!0){this.root&&function(e,t=null,s=null){const n=[];for(n.push(e),n.push(null),n.push(0);n.length>0;){const e=n.pop(),r=n.pop(),i=n.pop();if(t&&t(i,r,e))return void(s&&s(i,r,e));const o=i.children;if(o)for(let t=o.length-1;t>=0;t--)n.push(o[t]),n.push(i),n.push(e+1);s&&s(i,r,e)}}(this.root,(t,...n)=>(s&&this.ensureChildrenArePreprocessed(t,!0),!!e&&e(t,...n)),t)}queueTileForDownload(e){0===e.__loadingState&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:s,root:n,downloadQueue:r,parseQueue:i,processNodeQueue:o}=this;if(0===this.rootLoadingState&&(this.rootLoadingState=1,this.invokeOnePlugin(e=>e.loadRootTileSet&&e.loadRootTileSet()).then(e=>{let t=this.rootURL;null!==t&&this.invokeAllPlugins(e=>t=e.preprocessURL?e.preprocessURL(t,null):t),this.rootLoadingState=3,this.rootTileSet=e,this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tile-set",tileSet:e,url:t})}).catch(e=>{this.rootLoadingState=Ne,console.error(e),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:e,url:this.rootURL})})),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach(t=>e.markUnused(t)),t.clear(),Ke(n,this),We(n,this),qe(n,this),Xe(n,this);const a=this.queuedTiles;a.sort(e.unloadPriorityCallback);for(let l=0,c=a.length;l<c&&!e.isFull();l++)this.requestTileContents(a[l]);a.length=0,e.scheduleUnload();!1===(r.running||i.running||o.running)&&!0===this.isLoading&&(this.cachedSinceLoadComplete.clear(),s.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}),this.isLoading=!1)}resetFailedTiles(){this.rootLoadingState===Ne&&(this.rootLoadingState=0);const e=this.stats;0!==e.failed&&(this.traverse(e=>{e.__loadingState===Ne&&(e.__loadingState=0)},null,!1),e.failed=0)}dispose(){[...this.plugins].forEach(e=>{this.unregisterPlugin(e)});const e=this.lruCache,t=[];this.traverse(e=>(t.push(e),!1),null,!1);for(let s=0,n=t.length;s<n;s++)e.remove(t[s]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}calculateBytesUsed(e,t){return 0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,!1)),e.__visible=!1),e.__active&&(this.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,!1)),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(this.processedTiles.add(e),e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],null==(n=e.content)?void 0:n.uri){const t=Me(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=Boolean(t&&/json$/.test(t)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__childrenProcessed=0,s&&s.__childrenProcessed++,e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,null===s?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(n=>{n!==this&&n.preprocessNode&&n.preprocessNode(e,t,s)})}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateTileViewError(e,t){}ensureChildrenArePreprocessed(e,t=!1){const s=e.children;for(let n=0,r=s.length;n<r;n++){const r=s[n];if("__depth"in r)break;t?(this.processNodeQueue.remove(r),this.preprocessNode(r,e.__basePath,e)):this.processNodeQueue.has(r)||this.processNodeQueue.add(r,t=>{this.preprocessNode(t,e.__basePath,e),this._dispatchNeedsUpdateEvent()})}}getBytesUsed(e){let t=0;return this.invokeAllPlugins(s=>{s.calculateBytesUsed&&(t+=s.calculateBytesUsed(e,e.cached.scene)||0)}),t}recalculateBytesUsed(e=null){const{lruCache:t,processedTiles:s}=this;null===e?t.itemSet.forEach(e=>{s.has(e)&&t.setMemoryUsage(e,this.getBytesUsed(e))}):t.setMemoryUsage(e,this.getBytesUsed(e))}preprocessTileSet(e,t,s=null){const n=e.asset.version,[r,i]=n.split(".").map(e=>parseInt(e));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&i>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let o=t.replace(/\/[^/]*$/,"");o=new URL(o,window.location.href).toString(),this.preprocessNode(e.root,o,s)}loadRootTileSet(){let e=this.rootURL;this.invokeAllPlugins(t=>e=t.preprocessURL?t.preprocessURL(e,null):e);return this.invokeOnePlugin(t=>t.fetchData&&t.fetchData(e,this.fetchOptions)).then(t=>{if(t instanceof Response){if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)}return t}).then(t=>(this.preprocessTileSet(t,e),t))}requestTileContents(e){if(0!==e.__loadingState)return;let o=!1,l=null,c=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(t=>c=t.preprocessURL?t.preprocessURL(c,e):c);const h=this.stats,u=this.lruCache,d=this.downloadQueue,p=this.parseQueue,m=Me(c),f=new AbortController,g=f.signal;return u.add(e,t=>{f.abort(),o?(t.children.length=0,t.__childrenProcessed=0):this.invokeAllPlugins(e=>{e.disposeTile&&e.disposeTile(t)}),h.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),h.inCacheSinceLoad--),1===t.__loadingState?h.downloading--:2===t.__loadingState&&h.parsing--,t.__loadingState=0,p.remove(t),d.remove(t)})?(this.isLoading||(this.isLoading=!0,this.dispatchEvent({type:"tiles-load-start"})),u.setMemoryUsage(e,this.getBytesUsed(e)),this.cachedSinceLoadComplete.add(e),h.inCacheSinceLoad++,h.inCache++,h.downloading++,e.__loadingState=1,d.add(e,o=>{if(g.aborted)return Promise.resolve();const l=this.invokeOnePlugin(e=>{return e.fetchData&&e.fetchData(c,(o=((e,t)=>{for(var s in t||(t={}))r.call(t,s)&&a(e,s,t[s]);if(n)for(var s of n(t))i.call(t,s)&&a(e,s,t[s]);return e})({},this.fetchOptions),t(o,s({signal:g}))));var o});return this.dispatchEvent({type:"tile-download-start",tile:e}),l}).then(e=>{if(!g.aborted){if(e instanceof Response){if(e.ok)return"json"===m?e.json():e.arrayBuffer();throw new Error(`Failed to load model with error code ${e.status}`)}return e}}).then(t=>{if(!g.aborted)return h.downloading--,h.parsing++,e.__loadingState=2,p.add(e,s=>g.aborted?Promise.resolve():"json"===m&&t.root?(this.preprocessTileSet(t,c,e),e.children.push(t.root),l=t,o=!0,Promise.resolve()):this.invokeOnePlugin(e=>e.parseTile&&e.parseTile(t,s,m,c,g)))}).then(()=>{if(!g.aborted){if(h.parsing--,e.__loadingState=3,u.setLoaded(e,!0),0===u.getMemoryUsage(e)){const t=this.getBytesUsed(e);if(u.isFull()&&t>0)return void u.remove(e);u.setMemoryUsage(e,t)}this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),o&&this.dispatchEvent({type:"load-tile-set",tileSet:l,url:c}),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e})}}).catch(t=>{g.aborted||("AbortError"!==t.name?(p.remove(e),d.remove(e),2===e.__loadingState?h.parsing--:1===e.__loadingState&&h.downloading--,h.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(t),e.__loadingState=Ne,u.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:t,url:c})):u.remove(e))})):void 0}getAttributions(e=[]){return this.invokeAllPlugins(t=>t!==this&&t.getAttributions&&t.getAttributions(e)),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return 0===s.length?null:Promise.all(s)}}class Ze{constructor(){this.fetchOptions={},this.workingPath=""}load(...e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(...e)}loadAsync(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);t.pop();return t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}const et=new TextDecoder;function tt(e){return et.decode(e)}function st(e,t,s,n,r,i){let o,a;switch(n){case"SCALAR":o=1;break;case"VEC2":o=2;break;case"VEC3":o=3;break;case"VEC4":o=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${i}".`)}const l=s*o;switch(r){case"BYTE":a=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":a=new Uint8Array(e,t,l);break;case"SHORT":a=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":a=new Uint16Array(e,t,l);break;case"INT":a=new Int32Array(e,t,l);break;case"UNSIGNED_INT":a=new Uint32Array(e,t,l);break;case"FLOAT":a=new Float32Array(e,t,l);break;case"DOUBLE":a=new Float64Array(e,t,l);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${i}".`)}return a}class nt{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let r=null;if(0!==s){const n=new Uint8Array(e,t,s);r=JSON.parse(tt(n))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const r=this.header;if(!(e in r))return null;const i=r[e];if(i instanceof Object){if(Array.isArray(i))return i;{const{buffer:r,binOffset:o,binLength:a}=this,l=i.byteOffset||0,c=i.type||n,h=i.componentType||s;if("type"in i&&n&&i.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const u=o+l,d=st(r,u,t,c,h,e);if(u+d.byteLength>o+a)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return i}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class rt{constructor(e){var t;this.batchTable=e;const s=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=s.classes;for(const r of this.classes){const e=r.instances;for(const t in e)r.instances[t]=this._parseProperty(e[t],r.length,t)}if(this.instancesLength=s.instancesLength,this.classIds=this._parseProperty(s.classIds,this.instancesLength,"classIds"),s.parentCounts?this.parentCounts=this._parseProperty(s.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),s.parentIds){const e=this.parentCounts.reduce((e,t)=>e+t,0);this.parentIds=this._parseProperty(s.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const r of this.classIds)n[r]=null!=(t=n[r])?t:0,this.instancesIds.push(n[r]),n[r]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:r}=this.batchTable;return st(n,r+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let n=0;for(let t=0;t<e;t++)n+=this.parentCounts[t];for(let r=0;r<s;r++){const s=this.parentIds[n+r];s!==e&&this.getDataFromId(s,t)}}const n=this.classIds[e],r=this.classes[n].instances,i=this.classes[n].name,o=this.instancesIds[e];for(const a in r)t[i]=t[i]||{},t[i][a]=r[a][o];return t}}class it extends nt{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,r){super(e,s,n,r),this.count=t,this.extensions={};const i=this.header.extensions;i&&i["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new rt(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error(`BatchTable: id value "${e}" out of bounds for "${this.count}" features number.`);for(const s of this.getKeys())"extensions"!==s&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}function ot(e){if(null===e||e.byteLength<4)return"";let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let s="";for(let n=0;n<4;n++)s+=String.fromCharCode(t.getUint8(n));return s}class at extends Ze{parse(e){const t=new DataView(e),s=ot(t);console.assert("b3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new nt(c,0,i,o),u=28+i+o,d=e.slice(u,u+a+l),p=new it(d,h.getData("BATCH_LENGTH"),0,a,l),m=u+a+l;return{version:n,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,m,r-m)}}}class lt extends Ze{parse(e){const t=new DataView(e),s=ot(t);console.assert("i3dm"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+i+o),u=new nt(h,0,i,o),d=32+i+o,p=e.slice(d,d+a+l),m=new it(p,u.getData("INSTANCES_LENGTH"),0,a,l),f=d+a+l,g=new Uint8Array(e,f,r-f);let _=null,T=null,y=null;if(c)_=g,T=Promise.resolve();else{const e=this.resolveExternalURL(tt(g)),t=e.split(/[\\/]/g);t.pop(),y=t.join("/"),T=fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(e=>{_=new Uint8Array(e)})}return T.then(()=>({version:n,featureTable:u,batchTable:m,glbBytes:_,gltfWorkingPath:y}))}}class ct extends Ze{parse(e){const t=new DataView(e),s=ot(t);console.assert("pnts"===s);const n=t.getUint32(4,!0);console.assert(1===n);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const i=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+i+o),h=new nt(c,0,i,o),u=28+i+o,d=e.slice(u,u+a+l),p=new it(d,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:n,featureTable:h,batchTable:p})}}class ht extends Ze{parse(e){const t=new DataView(e),s=ot(t);console.assert("cmpt"===s,'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(1===n,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const i=t.getUint32(12,!0),o=[];let a=16;for(let l=0;l<i;l++){const t=new DataView(e,a,12),s=ot(t),n=t.getUint32(4,!0),r=t.getUint32(8,!0),i=new Uint8Array(e,a,r);o.push({type:s,buffer:i,version:n}),a+=r}return{version:n,tiles:o}}}function ut(e,t){if(t===c)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===h||t===u){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,r=[];if(t===h)for(let e=1;e<=n;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=e.clone();return i.setIndex(r),i.clearGroups(),i}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class dt extends d{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new Tt(e)}),this.register(function(e){return new yt(e)}),this.register(function(e){return new Lt(e)}),this.register(function(e){return new Ct(e)}),this.register(function(e){return new Pt(e)}),this.register(function(e){return new At(e)}),this.register(function(e){return new xt(e)}),this.register(function(e){return new wt(e)}),this.register(function(e){return new Rt(e)}),this.register(function(e){return new _t(e)}),this.register(function(e){return new Et(e)}),this.register(function(e){return new bt(e)}),this.register(function(e){return new St(e)}),this.register(function(e){return new vt(e)}),this.register(function(e){return new ft(e)}),this.register(function(e){return new Mt(e)}),this.register(function(e){return new It(e)})}load(e,t,s,n){const r=this;let i;if(""!==this.resourcePath)i=this.resourcePath;else if(""!==this.path){const t=p.extractUrlBase(e);i=p.resolveURL(t,this.path)}else i=p.extractUrlBase(e);this.manager.itemStart(e);const o=function(t){n?n(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},a=new m(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(s){try{r.parse(s,i,function(s){t(s),r.manager.itemEnd(e)},o)}catch(n){o(n)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let r;const i={},o={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(a.decode(new Uint8Array(e,0,4))===Ot){try{i[mt.KHR_BINARY_GLTF]=new Ut(e)}catch(c){return void(n&&n(c))}r=JSON.parse(i[mt.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new ls(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](l);e.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[e.name]=e,i[e.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const e=r.extensionsUsed[h],t=r.extensionsRequired||[];switch(e){case mt.KHR_MATERIALS_UNLIT:i[e]=new gt;break;case mt.KHR_DRACO_MESH_COMPRESSION:i[e]=new kt(r,this.dracoLoader);break;case mt.KHR_TEXTURE_TRANSFORM:i[e]=new Dt;break;case mt.KHR_MESH_QUANTIZATION:i[e]=new Bt;break;default:t.indexOf(e)>=0&&void 0===o[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}l.setExtensions(i),l.setPlugins(o),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,r){s.parse(e,t,n,r)})}}function pt(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const mt={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class ft{constructor(e){this.parser=e,this.name=mt.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const r=t.json,i=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let o;const a=new _(16777215);void 0!==i.color&&a.setRGB(i.color[0],i.color[1],i.color[2],T);const l=void 0!==i.range?i.range:0;switch(i.type){case"directional":o=new x(a),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new A(a),o.distance=l;break;case"spot":o=new b(a),o.distance=l,i.spot=i.spot||{},i.spot.innerConeAngle=void 0!==i.spot.innerConeAngle?i.spot.innerConeAngle:0,i.spot.outerConeAngle=void 0!==i.spot.outerConeAngle?i.spot.outerConeAngle:Math.PI/4,o.angle=i.spot.outerConeAngle,o.penumbra=1-i.spot.innerConeAngle/i.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+i.type)}return o.position.set(0,0,0),o.decay=2,ss(o,i),void 0!==i.intensity&&(o.intensity=i.intensity),o.name=t.createUniqueName(i.name||"light_"+e),n=Promise.resolve(o),t.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then(function(e){return s._getNodeRef(t.cache,r,e)})}}class gt{constructor(){this.name=mt.KHR_MATERIALS_UNLIT}getMaterialType(){return q}extendParams(e,t,s){const n=[];e.color=new _(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],T),e.opacity=t[3]}void 0!==r.baseColorTexture&&n.push(s.assignTexture(e,"map",r.baseColorTexture,y))}return Promise.all(n)}}class _t{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return void 0!==n&&(t.emissiveIntensity=n),Promise.resolve()}}class Tt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];if(void 0!==i.clearcoatFactor&&(t.clearcoat=i.clearcoatFactor),void 0!==i.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",i.clearcoatTexture)),void 0!==i.clearcoatRoughnessFactor&&(t.clearcoatRoughness=i.clearcoatRoughnessFactor),void 0!==i.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",i.clearcoatRoughnessTexture)),void 0!==i.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",i.clearcoatNormalTexture)),void 0!==i.clearcoatNormalTexture.scale)){const e=i.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new g(e,e)}return Promise.all(r)}}class yt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=void 0!==n.dispersion?n.dispersion:0,Promise.resolve()}}class bt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return void 0!==i.iridescenceFactor&&(t.iridescence=i.iridescenceFactor),void 0!==i.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),void 0!==i.iridescenceIor&&(t.iridescenceIOR=i.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==i.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),void 0!==i.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(r)}}class At{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new _(0,0,0),t.sheenRoughness=0,t.sheen=1;const i=n.extensions[this.name];if(void 0!==i.sheenColorFactor){const e=i.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],T)}return void 0!==i.sheenRoughnessFactor&&(t.sheenRoughness=i.sheenRoughnessFactor),void 0!==i.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",i.sheenColorTexture,y)),void 0!==i.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",i.sheenRoughnessTexture)),Promise.all(r)}}class xt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return void 0!==i.transmissionFactor&&(t.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(r)}}class wt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.thickness=void 0!==i.thicknessFactor?i.thicknessFactor:0,void 0!==i.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",i.thicknessTexture)),t.attenuationDistance=i.attenuationDistance||1/0;const o=i.attenuationColor||[1,1,1];return t.attenuationColor=(new _).setRGB(o[0],o[1],o[2],T),Promise.all(r)}}class Rt{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=void 0!==n.ior?n.ior:1.5,Promise.resolve()}}class Et{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];t.specularIntensity=void 0!==i.specularFactor?i.specularFactor:1,void 0!==i.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",i.specularTexture));const o=i.specularColorFactor||[1,1,1];return t.specularColor=(new _).setRGB(o[0],o[1],o[2],T),void 0!==i.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",i.specularColorTexture,y)),Promise.all(r)}}class vt{constructor(e){this.parser=e,this.name=mt.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return t.bumpScale=void 0!==i.bumpFactor?i.bumpFactor:1,void 0!==i.bumpTexture&&r.push(s.assignTexture(t,"bumpMap",i.bumpTexture)),Promise.all(r)}}class St{constructor(e){this.parser=e,this.name=mt.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?f:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],i=n.extensions[this.name];return void 0!==i.anisotropyStrength&&(t.anisotropy=i.anisotropyStrength),void 0!==i.anisotropyRotation&&(t.anisotropyRotation=i.anisotropyRotation),void 0!==i.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",i.anisotropyTexture)),Promise.all(r)}}class Lt{constructor(e){this.parser=e,this.name=mt.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,i)}}class Ct{constructor(e){this.parser=e,this.name=mt.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,i.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class Pt{constructor(e){this.parser=e,this.name=mt.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const i=r.extensions[t],o=n.images[i.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then(function(r){if(r)return s.loadTextureImage(e,i.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class Mt{constructor(e){this.name=mt.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(t){const s=e.byteOffset||0,n=e.byteLength||0,i=e.count,o=e.byteStride,a=new Uint8Array(t,s,n);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(i,o,a,e.mode,e.filter).then(function(e){return e.buffer}):r.ready.then(function(){const t=new ArrayBuffer(i*o);return r.decodeGltfBuffer(new Uint8Array(t),i,o,a,e.mode,e.filter),t})})}return null}}class It{constructor(e){this.name=mt.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=t.meshes[s.mesh];for(const a of n.primitives)if(a.mode!==Gt.TRIANGLES&&a.mode!==Gt.TRIANGLE_STRIP&&a.mode!==Gt.TRIANGLE_FAN&&void 0!==a.mode)return null;const r=s.extensions[this.name].attributes,i=[],o={};for(const a in r)i.push(this.parser.getDependency("accessor",r[a]).then(e=>(o[a]=e,o[a])));return i.length<1?null:(i.push(this.parser.createNodeMesh(e)),Promise.all(i).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],n=e[0].count,r=[];for(const i of s){const e=new w,t=new R,s=new v,a=new R(1,1,1),l=new E(i.geometry,i.material,n);for(let r=0;r<n;r++)o.TRANSLATION&&t.fromBufferAttribute(o.TRANSLATION,r),o.ROTATION&&s.fromBufferAttribute(o.ROTATION,r),o.SCALE&&a.fromBufferAttribute(o.SCALE,r),l.setMatrixAt(r,e.compose(t,s,a));for(const n in o)if("_COLOR_0"===n){const e=o[n];l.instanceColor=new S(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==n&&"ROTATION"!==n&&"SCALE"!==n&&i.geometry.setAttribute(n,o[n]);L.prototype.copy.call(l,i),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}}const Ot="glTF",Ft=1313821514,Nt=5130562;class Ut{constructor(e){this.name=mt.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Ot)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-12,r=new DataView(e,12);let i=0;for(;i<n;){const t=r.getUint32(i,!0);i+=4;const n=r.getUint32(i,!0);if(i+=4,n===Ft){const n=new Uint8Array(e,12+i,t);this.content=s.decode(n)}else if(n===Nt){const s=12+i;this.body=e.slice(s,s+t)}i+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class kt{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=mt.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,o={},a={},l={};for(const c in i){const e=Xt[c]||c.toLowerCase();o[e]=i[c]}for(const c in e.attributes){const t=Xt[c]||c.toLowerCase();if(void 0!==i[c]){const n=s.accessors[e.attributes[c]],r=zt[n.componentType];l[t]=r.name,a[t]=!0===n.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t,s){n.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)},o,l,T,s)})})}}class Dt{constructor(){this.name=mt.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Bt{constructor(){this.name=mt.KHR_MESH_QUANTIZATION}}class Ht extends Te{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let i=0;i!==n;i++)t[i]=s[r+i];return t}interpolate_(e,t,s,n){const r=this.resultBuffer,i=this.sampleValues,o=this.valueSize,a=2*o,l=3*o,c=n-t,h=(s-t)/c,u=h*h,d=u*h,p=e*l,m=p-l,f=-2*d+3*u,g=d-u,_=1-f,T=g-u+h;for(let y=0;y!==o;y++){const e=i[m+y+o],t=i[m+y+a]*c,s=i[p+y+o],n=i[p+y]*c;r[y]=_*e+T*t+f*s+g*n}return r}}const Vt=new v;class jt extends Ht{interpolate_(e,t,s,n){const r=super.interpolate_(e,t,s,n);return Vt.fromArray(r).normalize().toArray(r),r}}const Gt={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},zt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Kt={9728:D,9729:k,9984:U,9985:N,9986:F,9987:O},Wt={33071:V,33648:H,10497:B},qt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Xt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Yt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Qt={CUBICSPLINE:void 0,LINEAR:he,STEP:ce},$t="OPAQUE",Jt="MASK",Zt="BLEND";function es(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new K({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:_e})),e.DefaultMaterial}function ts(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function ss(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ns(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function rs(e){let t;const s=e.extensions&&e.extensions[mt.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+is(s.attributes):e.indices+":"+is(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,r=e.targets.length;n<r;n++)t+=":"+is(e.targets[n]);return t}function is(e){let t="";const s=Object.keys(e).sort();for(let n=0,r=s.length;n<r;n++)t+=s[n]+":"+e[s[n]]+";";return t}function os(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const as=new w;class ls{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new pt,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,r=!1,i=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);n=s&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,i=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&n<17||r&&i<98?this.textureLoader=new C(this.options.manager):this.textureLoader=new P(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new m(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const i={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};return ts(r,i,n),ss(i,n),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(i)})).then(function(){for(const e of i.scenes)e.updateMatrixWorld();e(i)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const s=t[n].joints;for(let t=0,n=s.length;t<n;t++)e[s[t]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),r=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[n,i]of e.children.entries())r(i,t.children[n])};return r(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":n=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map(function(t,n){return s.getDependency(e,n)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[mt.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(e,r){s.load(p.resolveURL(t.uri,n.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=qt[n.type],t=zt[n.componentType],s=!0===n.normalized,r=new t(n.count*e);return Promise.resolve(new M(r,e,s))}const r=[];return void 0!==n.bufferView?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then(function(e){const r=e[0],i=qt[n.type],o=zt[n.componentType],a=o.BYTES_PER_ELEMENT,l=a*i,c=n.byteOffset||0,h=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,u=!0===n.normalized;let d,p;if(h&&h!==l){const e=Math.floor(c/h),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(s);l||(d=new o(r,e*h,n.count*h/a),l=new I(d,h/a),t.cache.add(s,l)),p=new ue(l,i,c%h/a,u)}else d=null===r?new o(n.count*i):new o(r,c,n.count*i),p=new M(d,i,u);if(void 0!==n.sparse){const t=qt.SCALAR,s=zt[n.sparse.indices.componentType],a=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new s(e[1],a,n.sparse.count*t),h=new o(e[2],l,n.sparse.count*i);null!==r&&(p=new M(p.array.slice(),p.itemSize,p.normalized));for(let e=0,n=c.length;e<n;e++){const t=c[e];if(p.setX(t,h[e*i]),i>=2&&p.setY(t,h[e*i+1]),i>=3&&p.setZ(t,h[e*i+2]),i>=4&&p.setW(t,h[e*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p})}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e].source,r=t.images[n];let i=this.textureLoader;if(r.uri){const e=s.manager.getHandler(r.uri);null!==e&&(i=e)}return this.loadTextureImage(e,n,i)}loadTextureImage(e,t,s){const n=this,r=this.json,i=r.textures[e],o=r.images[t],a=(o.uri||o.bufferView)+":"+i.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=i.name||o.name||"",""===t.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(t.name=o.uri);const s=(r.samplers||{})[i.sampler]||{};return t.magFilter=Kt[s.magFilter]||k,t.minFilter=Kt[s.minFilter]||O,t.wrapS=Wt[s.wrapS]||B,t.wrapT=Wt[s.wrapT]||B,n.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[a]=l,l}loadImageSource(e,t){const s=this,n=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const i=n.images[e],o=self.URL||self.webkitURL;let a=i.uri||"",l=!1;if(void 0!==i.bufferView)a=s.getDependency("bufferView",i.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:i.mimeType});return a=o.createObjectURL(t),a});else if(void 0===i.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(a).then(function(e){return new Promise(function(s,n){let i=s;!0===t.isImageBitmapLoader&&(i=function(e){const t=new de(e);t.needsUpdate=!0,s(t)}),t.load(p.resolveURL(e,r.path),i,void 0,n)})}).then(function(e){var t;return!0===l&&o.revokeObjectURL(a),ss(e,i),e.userData.mimeType=i.mimeType||((t=i.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e});return this.sourceCache[e]=c,c}assignTexture(e,t,s,n){const r=this;return this.getDependency("texture",s.index).then(function(i){if(!i)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((i=i.clone()).channel=s.texCoord),r.extensions[mt.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[mt.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(i);i=r.extensions[mt.KHR_TEXTURE_TRANSFORM].extendTexture(i,e),r.associations.set(i,t)}}return void 0!==n&&(i.colorSpace=n),e[t]=i,i})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,i=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new j,G.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new z,G.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(n||r||i){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),i&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),i&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return K}loadMaterial(e){const t=this,s=this.json,n=this.extensions,r=s.materials[e];let i;const o={},a=[];if((r.extensions||{})[mt.KHR_MATERIALS_UNLIT]){const e=n[mt.KHR_MATERIALS_UNLIT];i=e.getMaterialType(),a.push(e.extendParams(o,r,t))}else{const s=r.pbrMetallicRoughness||{};if(o.color=new _(1,1,1),o.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],T),o.opacity=e[3]}void 0!==s.baseColorTexture&&a.push(t.assignTexture(o,"map",s.baseColorTexture,y)),o.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,o.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(a.push(t.assignTexture(o,"metalnessMap",s.metallicRoughnessTexture)),a.push(t.assignTexture(o,"roughnessMap",s.metallicRoughnessTexture))),i=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),a.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)})))}!0===r.doubleSided&&(o.side=W);const l=r.alphaMode||$t;if(l===Zt?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,l===Jt&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&i!==q&&(a.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new g(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&i!==q&&(a.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&i!==q){const e=r.emissiveFactor;o.emissive=(new _).setRGB(e[0],e[1],e[2],T)}return void 0!==r.emissiveTexture&&i!==q&&a.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,y)),Promise.all(a).then(function(){const s=new i(o);return r.name&&(s.name=r.name),ss(s,r),t.associations.set(s,{materials:e}),r.extensions&&ts(n,s,r),s})}createUniqueName(e){const t=X.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function r(e){return s[mt.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return cs(s,e,t)})}const i=[];for(let o=0,a=e.length;o<a;o++){const s=e[o],a=rs(s),l=n[a];if(l)i.push(l.promise);else{let e;e=s.extensions&&s.extensions[mt.KHR_DRACO_MESH_COMPRESSION]?r(s):cs(new Y,s,t),n[a]={primitive:s,promise:e},i.push(e)}}return Promise.all(i)}loadMesh(e){const t=this,s=this.json,n=this.extensions,r=s.meshes[e],i=r.primitives,o=[];for(let a=0,l=i.length;a<l;a++){const e=void 0===i[a].material?es(this.cache):this.getDependency("material",i[a].material);o.push(e)}return o.push(t.loadGeometries(i)),Promise.all(o).then(function(s){const o=s.slice(0,s.length-1),a=s[s.length-1],l=[];for(let d=0,p=a.length;d<p;d++){const s=a[d],c=i[d];let p;const m=o[d];if(c.mode===Gt.TRIANGLES||c.mode===Gt.TRIANGLE_STRIP||c.mode===Gt.TRIANGLE_FAN||void 0===c.mode)p=!0===r.isSkinnedMesh?new Q(s,m):new $(s,m),!0===p.isSkinnedMesh&&p.normalizeSkinWeights(),c.mode===Gt.TRIANGLE_STRIP?p.geometry=ut(p.geometry,u):c.mode===Gt.TRIANGLE_FAN&&(p.geometry=ut(p.geometry,h));else if(c.mode===Gt.LINES)p=new J(s,m);else if(c.mode===Gt.LINE_STRIP)p=new Z(s,m);else if(c.mode===Gt.LINE_LOOP)p=new ee(s,m);else{if(c.mode!==Gt.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);p=new te(s,m)}Object.keys(p.geometry.morphAttributes).length>0&&ns(p,r),p.name=t.createUniqueName(r.name||"mesh_"+e),ss(p,r),c.extensions&&ts(n,p,c),t.assignFinalMaterial(p),l.push(p)}for(let n=0,r=l.length;n<r;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return r.extensions&&ts(n,l[0],r),l[0];const c=new se;r.extensions&&ts(n,c,r),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new ne(re.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new ie(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),ss(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,r=t.joints.length;n<r;n++)s.push(this._loadNodeShallow(t.joints[n]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const s=e.pop(),n=e,r=[],i=[];for(let o=0,a=n.length;o<a;o++){const e=n[o];if(e){r.push(e);const t=new w;null!==s&&t.fromArray(s.array,16*o),i.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[o])}return new oe(r,i)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],r=n.name?n.name:"animation_"+e,i=[],o=[],a=[],l=[],c=[];for(let h=0,u=n.channels.length;h<u;h++){const e=n.channels[h],t=n.samplers[e.sampler],s=e.target,r=s.node,u=void 0!==n.parameters?n.parameters[t.input]:t.input,d=void 0!==n.parameters?n.parameters[t.output]:t.output;void 0!==s.node&&(i.push(this.getDependency("node",r)),o.push(this.getDependency("accessor",u)),a.push(this.getDependency("accessor",d)),l.push(t),c.push(s))}return Promise.all([Promise.all(i),Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(c)]).then(function(e){const t=e[0],n=e[1],i=e[2],o=e[3],a=e[4],l=[];for(let r=0,c=t.length;r<c;r++){const e=t[r],c=n[r],h=i[r],u=o[r],d=a[r];if(void 0===e)continue;e.updateMatrix&&e.updateMatrix();const p=s._createAnimationTracks(e,c,h,u,d);if(p)for(let t=0;t<p.length;t++)l.push(p[t])}return new ae(r,void 0,l)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],n=t._loadNodeShallow(e),r=[],i=s.children||[];for(let a=0,l=i.length;a<l;a++)r.push(t.getDependency("node",i[a]));const o=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([n,Promise.all(r),o]).then(function(e){const t=e[0],s=e[1],n=e[2];null!==n&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(n,as)});for(let r=0,i=s.length;r<i;r++)t.add(s[r]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],i=r.name?n.createUniqueName(r.name):"",o=[],a=n._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return a&&o.push(a),void 0!==r.camera&&o.push(n.getDependency("camera",r.camera).then(function(e){return n._getNodeRef(n.cameraCache,r.camera,e)})),n._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){o.push(e)}),this.nodeCache[e]=Promise.all(o).then(function(t){let o;if(o=!0===r.isBone?new le:t.length>1?new se:1===t.length?t[0]:new L,o!==t[0])for(let e=0,s=t.length;e<s;e++)o.add(t[e]);if(r.name&&(o.userData.name=r.name,o.name=i),ss(o,r),r.extensions&&ts(s,o,r),void 0!==r.matrix){const e=new w;e.fromArray(r.matrix),o.applyMatrix4(e)}else void 0!==r.translation&&o.position.fromArray(r.translation),void 0!==r.rotation&&o.quaternion.fromArray(r.rotation),void 0!==r.scale&&o.scale.fromArray(r.scale);return n.associations.has(o)||n.associations.set(o,{}),n.associations.get(o).nodes=e,o}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,r=new se;s.name&&(r.name=n.createUniqueName(s.name)),ss(r,s),s.extensions&&ts(t,r,s);const i=s.nodes||[],o=[];for(let a=0,l=i.length;a<l;a++)o.push(n.getDependency("node",i[a]));return Promise.all(o).then(function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return n.associations=(e=>{const t=new Map;for(const[s,r]of n.associations)(s instanceof G||s instanceof de)&&t.set(s,r);return e.traverse(e=>{const s=n.associations.get(e);null!=s&&t.set(e,s)}),t})(r),r})}_createAnimationTracks(e,t,s,n,r){const i=[],o=e.name?e.name:e.uuid,a=[];let l;switch(Yt[r.path]===Yt.weights?e.traverse(function(e){e.morphTargetInfluences&&a.push(e.name?e.name:e.uuid)}):a.push(o),Yt[r.path]){case Yt.weights:l=me;break;case Yt.rotation:l=fe;break;case Yt.position:case Yt.scale:l=pe;break;default:if(1===s.itemSize)l=me;else l=pe}const c=void 0!==n.interpolation?Qt[n.interpolation]:he,h=this._getArrayFromAccessor(s);for(let u=0,d=a.length;u<d;u++){const e=new l(a[u]+"."+Yt[r.path],t.array,h,c);"CUBICSPLINE"===n.interpolation&&this._createCubicSplineTrackInterpolant(e),i.push(e)}return i}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=os(t.constructor),s=new Float32Array(t.length);for(let n=0,r=t.length;n<r;n++)s[n]=t[n]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof fe?jt:Ht)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function cs(e,t,s){const n=t.attributes,r=[];function i(t,n){return s.getDependency("accessor",t).then(function(t){e.setAttribute(n,t)})}for(const o in n){const t=Xt[o]||o.toLowerCase();t in e.attributes||r.push(i(n[o],t))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(n)}return ge.workingColorSpace!==T&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ge.workingColorSpace}" not supported.`),ss(e,t),function(e,t,s){const n=t.attributes,r=new ye;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,i=e.max;if(void 0===t||void 0===i)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new R(t[0],t[1],t[2]),new R(i[0],i[1],i[2])),e.normalized){const t=os(zt[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const i=t.targets;if(void 0!==i){const e=new R,t=new R;for(let n=0,r=i.length;n<r;n++){const r=i[n];if(void 0!==r.POSITION){const n=s.json.accessors[r.POSITION],i=n.min,o=n.max;if(void 0!==i&&void 0!==o){if(t.setX(Math.max(Math.abs(i[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(i[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(i[2]),Math.abs(o[2]))),n.normalized){const e=os(zt[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const o=new be;r.getCenter(o.center),o.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=o}(e,t,s),Promise.all(r).then(function(){return void 0!==t.targets?function(e,t,s){let n=!1,r=!1,i=!1;for(let c=0,h=t.length;c<h;c++){const e=t[c];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(r=!0),void 0!==e.COLOR_0&&(i=!0),n&&r&&i)break}if(!n&&!r&&!i)return Promise.resolve(e);const o=[],a=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(n){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;o.push(t)}if(r){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;a.push(t)}if(i){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(l)]).then(function(t){const s=t[0],o=t[1],a=t[2];return n&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=o),i&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e})}(e,t.targets,s):e})}class hs extends at{constructor(e=Ae){super(),this.manager=e,this.adjustmentTransform=new w}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((e,n)=>{const r=this.manager,i=this.fetchOptions,o=r.getHandler("path.gltf")||new dt(r);"include"===i.credentials&&"cors"===i.mode&&o.setCrossOrigin("use-credentials"),"credentials"in i&&o.setWithCredentials("include"===i.credentials),i.headers&&o.setRequestHeader(i.headers);let a=this.workingPath;!/[\\/]$/.test(a)&&a.length&&(a+="/");const l=this.adjustmentTransform;o.parse(s,a,s=>{const{batchTable:n,featureTable:r}=t,{scene:i}=s,o=r.getData("RTC_CENTER",1,"FLOAT","VEC3");o&&(i.position.x+=o[0],i.position.y+=o[1],i.position.z+=o[2]),s.scene.updateMatrix(),s.scene.matrix.multiply(l),s.scene.matrix.decompose(s.scene.position,s.scene.quaternion,s.scene.scale),s.batchTable=n,s.featureTable=r,i.batchTable=n,i.featureTable=r,e(s)},n)})}}function us(e){const t=e>>11,s=e>>5&63,n=31&e;return[Math.round(t/31*255),Math.round(s/63*255),Math.round(n/31*255)]}const ds=new g;function ps(e,t,s=new R){ds.set(e,t).divideScalar(256).multiplyScalar(2).subScalar(1),s.set(ds.x,ds.y,1-Math.abs(ds.x)-Math.abs(ds.y));const n=re.clamp(-s.z,0,1);return s.x>=0?s.setX(s.x-n):s.setX(s.x+n),s.y>=0?s.setY(s.y-n):s.setY(s.y+n),s.normalize(),s}const ms={RGB:"color",POSITION:"position"};class fs extends ct{constructor(e=Ae){super(),this.manager=e}parse(e){return super.parse(e).then(e=>l(this,null,function*(){const{featureTable:t,batchTable:s}=e,n=new j,r=t.header.extensions,i=new R;let o;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:s,properties:i}=r["3DTILES_draco_point_compression"],a=this.manager.getHandler("draco.drc");if(null==a)throw new Error("PNTSLoader: dracoLoader not available.");const l={};for(const t in i)if(t in ms&&t in i){l[ms[t]]=i[t]}const c={attributeIDs:l,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},h=t.getBuffer(e,s);o=yield a.decodeGeometry(h,c),o.attributes.color&&(n.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),s=t.getData("POSITION",e,"FLOAT","VEC3"),r=t.getData("NORMAL",e,"FLOAT","VEC3"),a=t.getData("NORMAL",e,"UNSIGNED_BYTE","VEC2"),l=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),c=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),h=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),u=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),d=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),p=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),m=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(o=new Y,d){const t=new Float32Array(3*e);for(let s=0;s<e;s++)for(let e=0;e<3;e++){const n=3*s+e;t[n]=d[n]/65535*p[e]}i.x=m[0],i.y=m[1],i.z=m[2],o.setAttribute("position",new M(t,3,!1))}else o.setAttribute("position",new M(s,3,!1));if(null!==r)o.setAttribute("normal",new M(r,3,!1));else if(null!==a){const t=new Float32Array(3*e),s=new R;for(let n=0;n<e;n++){const e=ps(a[2*n],a[2*n+1],s);t[3*n]=e.x,t[3*n+1]=e.y,t[3*n+2]=e.z}o.setAttribute("normal",new M(t,3,!1))}if(null!==c)o.setAttribute("color",new M(c,4,!0)),n.vertexColors=!0,n.transparent=!0,n.depthWrite=!1;else if(null!==l)o.setAttribute("color",new M(l,3,!0)),n.vertexColors=!0;else if(null!==h){const t=new Uint8Array(3*e);for(let s=0;s<e;s++){const e=us(h[s]);for(let n=0;n<3;n++){t[3*s+n]=e[n]}}o.setAttribute("color",new M(t,3,!0)),n.vertexColors=!0}else if(null!==u){const e=new _(u[0],u[1],u[2]);n.color=e;const t=u[3]/255;t<1&&(n.opacity=t,n.transparent=!0,n.depthWrite=!1)}}const a=new te(o,n);a.position.copy(i),e.scene=a,e.scene.featureTable=t,e.scene.batchTable=s;const l=t.getData("RTC_CENTER",1,"FLOAT","VEC3");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}new xe,new R;const gs=new xe,_s=new R,Ts=new R,ys=new R,bs=new w,As=new w,xs=new w,ws=new be,Rs=new Re,Es=new R,vs=new R,Ss=new R,Ls=new R,Cs=new we;class Ps{constructor(e=1,t=1,s=1){this.name="",this.radius=new R(e,t,s)}intersectRay(e,t){return bs.makeScale(...this.radius).invert(),ws.center.set(0,0,0),ws.radius=1,Cs.copy(e).applyMatrix4(bs),Cs.intersectSphere(ws,t)?(bs.makeScale(...this.radius),t.applyMatrix4(bs),t):null}getEastNorthUpFrame(e,t,s,n){return s.isMatrix4&&(n=s,s=0,console.warn('Ellipsoid: The signature for "getEastNorthUpFrame" has changed.')),this.getEastNorthUpAxes(e,t,Es,vs,Ss),this.getCartographicToPosition(e,t,s,Ls),n.makeBasis(Es,vs,Ss).setPosition(Ls)}getOrientedEastNorthUpFrame(e,t,s,n,r,i,o){return this.getObjectFrame(e,t,s,n,r,i,o,0)}getObjectFrame(e,t,s,n,r,i,o,a=2){return this.getEastNorthUpFrame(e,t,s,bs),Rs.set(r,i,-n,"ZXY"),o.makeRotationFromEuler(Rs).premultiply(bs),1===a?(Rs.set(Math.PI/2,0,0,"XYZ"),As.makeRotationFromEuler(Rs),o.multiply(As)):2===a&&(Rs.set(-Math.PI/2,0,Math.PI,"XYZ"),As.makeRotationFromEuler(Rs),o.multiply(As)),o}getCartographicFromObjectFrame(e,t,s=2){return 1===s?(Rs.set(-Math.PI/2,0,0,"XYZ"),As.makeRotationFromEuler(Rs).premultiply(e)):2===s?(Rs.set(-Math.PI/2,0,Math.PI,"XYZ"),As.makeRotationFromEuler(Rs).premultiply(e)):As.copy(e),Ls.setFromMatrixPosition(As),this.getPositionToCartographic(Ls,t),this.getEastNorthUpFrame(t.lat,t.lon,0,bs).invert(),As.premultiply(bs),Rs.setFromRotationMatrix(As,"ZXY"),t.azimuth=-Rs.z,t.elevation=Rs.x,t.roll=Rs.y,t}getEastNorthUpAxes(e,t,s,n,r,i=Ls){this.getCartographicToPosition(e,t,0,i),this.getCartographicToNormal(e,t,r),s.set(-i.y,i.x,0).normalize(),n.crossVectors(r,s).normalize()}getAzElRollFromRotationMatrix(e,t,s,n,r=0){return console.warn('Ellipsoid: "getAzElRollFromRotationMatrix" is deprecated. Use "getCartographicFromObjectFrame", instead.'),this.getCartographicToPosition(e,t,0,Ls),xs.copy(s).setPosition(Ls),this.getCartographicFromObjectFrame(xs,n,r),delete n.height,delete n.lat,delete n.lon,n}getRotationMatrixFromAzElRoll(e,t,s,n,r,i,o=0){return console.warn('Ellipsoid: "getRotationMatrixFromAzElRoll" function has been deprecated. Use "getObjectFrame", instead.'),this.getObjectFrame(e,t,0,s,n,r,i,o),i.setPosition(0,0,0),i}getFrame(e,t,s,n,r,i,o,a=0){return console.warn('Ellipsoid: "getFrame" function has been deprecated. Use "getObjectFrame", instead.'),this.getObjectFrame(e,t,i,s,n,r,o,a)}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,_s);const r=this.radius;Ts.copy(_s),Ts.x*=o(r.x,2),Ts.y*=o(r.y,2),Ts.z*=o(r.z,2);const i=Math.sqrt(_s.dot(Ts));return Ts.divideScalar(i),n.copy(Ts).addScaledVector(_s,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,Ts),this.getPositionToNormal(e,_s);const s=ys.subVectors(e,Ts);return t.lon=Math.atan2(_s.y,_s.x),t.lat=Math.asin(_s.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return gs.set(1,-e+Math.PI/2,t),s.setFromSpherical(gs).normalize(),function(e){const{x:t,y:s,z:n}=e;e.x=n,e.y=t,e.z=s}(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=o(s.x,2),t.y/=o(s.y,2),t.z/=o(s.z,2),t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/o(s.x,2),r=1/o(s.y,2),i=1/o(s.z,2),a=e.x*e.x*n,l=e.y*e.y*r,c=e.z*e.z*i,h=a+l+c,u=Math.sqrt(1/h),d=Ts.copy(e).multiplyScalar(u);if(h<.1)return isFinite(u)?t.copy(d):null;const p=ys.set(d.x*n*2,d.y*r*2,d.z*i*2);let m,f,g,_,T,y,b,A,x,w,R,E=(1-u)*e.length()/(.5*p.length()),v=0;do{E-=v,g=1/(1+E*n),_=1/(1+E*r),T=1/(1+E*i),y=g*g,b=_*_,A=T*T,x=y*g,w=b*_,R=A*T,m=a*y+l*b+c*A-1,f=a*x*n+l*w*r+c*R*i;v=m/(-2*f)}while(Math.abs(m)>1e-12);return t.set(e.x*g,e.y*_,e.z*T)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+o(t,2))}calculateEffectiveRadius(e){const t=this.radius.x,s=this.radius.z,n=1-o(s,2)/o(t,2),r=e*re.DEG2RAD,i=o(Math.sin(r),2);return t/Math.sqrt(1-n*i)}getPositionElevation(e){this.getPositionToSurfacePoint(e,Ts);const t=ys.subVectors(e,Ts);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const Ms=new Ps(Ue,Ue,6356752.314245179);Ms.name="WGS84 Earth";const Is=new R,Os=new R,Fs=new R,Ns=new R,Us=new v,ks=new R,Ds=new w,Bs=new w,Hs=new R,Vs=new w,js=new v,Gs={};class zs extends lt{constructor(e=Ae){super(),this.manager=e,this.adjustmentTransform=new w,this.ellipsoid=Ms.clone()}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(e=>{const{featureTable:t,batchTable:s}=e,n=e.glbBytes.slice().buffer;return new Promise((r,i)=>{var o;const a=this.fetchOptions,l=this.manager,c=l.getHandler("path.gltf")||new dt(l);"include"===a.credentials&&"cors"===a.mode&&c.setCrossOrigin("use-credentials"),"credentials"in a&&c.setWithCredentials("include"===a.credentials),a.headers&&c.setRequestHeader(a.headers);let h=null!=(o=e.gltfWorkingPath)?o:this.workingPath;/[\\/]$/.test(h)||(h+="/");const u=this.adjustmentTransform;c.parse(n,h,e=>{const n=t.getData("INSTANCES_LENGTH"),i=t.getData("POSITION",n,"FLOAT","VEC3"),o=t.getData("NORMAL_UP",n,"FLOAT","VEC3"),a=t.getData("NORMAL_RIGHT",n,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",n,"FLOAT","VEC3"),c=t.getData("SCALE",n,"FLOAT","SCALAR"),h=t.getData("RTC_CENTER",1,"FLOAT","VEC3"),d=t.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)});const p=new R;for(let t=0;t<n;t++)p.x+=i[3*t+0]/n,p.y+=i[3*t+1]/n,p.z+=i[3*t+2]/n;const m=[],f=[];e.scene.updateMatrixWorld(),e.scene.traverse(e=>{if(e.isMesh){f.push(e);const{geometry:t,material:s}=e,r=new E(t,s,n);r.position.copy(p),h&&(r.position.x+=h[0],r.position.y+=h[1],r.position.z+=h[2]),m.push(r)}});for(let t=0;t<n;t++){Ns.set(i[3*t+0]-p.x,i[3*t+1]-p.y,i[3*t+2]-p.z),Us.identity(),o&&(Os.set(o[3*t+0],o[3*t+1],o[3*t+2]),Fs.set(a[3*t+0],a[3*t+1],a[3*t+2]),Is.crossVectors(Fs,Os).normalize(),Ds.makeBasis(Fs,Os,Is),Us.setFromRotationMatrix(Ds)),ks.set(1,1,1),l&&ks.set(l[3*t+0],l[3*t+1],l[3*t+2]),c&&ks.multiplyScalar(c[t]);for(let e=0,s=m.length;e<s;e++){const s=m[e];js.copy(Us),d&&(s.updateMatrixWorld(),Hs.copy(Ns).applyMatrix4(s.matrixWorld),this.ellipsoid.getPositionToCartographic(Hs,Gs),this.ellipsoid.getEastNorthUpFrame(Gs.lat,Gs.lon,Vs),js.setFromRotationMatrix(Vs)),Ds.compose(Ns,js,ks).multiply(u);const n=f[e];Bs.multiplyMatrices(Ds,n.matrixWorld),s.setMatrixAt(t,Bs)}}e.scene.clear(),e.scene.add(...m),e.batchTable=s,e.featureTable=t,e.scene.batchTable=s,e.scene.featureTable=t,r(e)},i)})})}}class Ks extends ht{constructor(e=Ae){super(),this.manager=e,this.adjustmentTransform=new w,this.ellipsoid=Ms.clone()}parse(e){const t=super.parse(e),{manager:s,ellipsoid:n,adjustmentTransform:r}=this,i=[];for(const o in t.tiles){const{type:e,buffer:a}=t.tiles[o];switch(e){case"b3dm":{const e=a.slice(),t=new hs(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(r);const n=t.parse(e.buffer);i.push(n);break}case"pnts":{const e=a.slice(),t=new fs(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const n=t.parse(e.buffer);i.push(n);break}case"i3dm":{const e=a.slice(),t=new zs(s);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.ellipsoid.copy(n),t.adjustmentTransform.copy(r);const o=t.parse(e.buffer);i.push(o);break}}}return Promise.all(i).then(e=>{const t=new se;return e.forEach(e=>{t.add(e.scene)}),{tiles:e,scene:t}})}}const Ws=new w;class qs extends se{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new w}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?Ws.copy(this.matrix):Ws.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=Ws.elements,t=this.matrixWorld.elements;let s=!1;for(let n=0;n<16;n++){const r=e[n],i=t[n];if(Math.abs(r-i)>Number.EPSILON){s=!0;break}}if(s){this.matrixWorld.copy(Ws),this.matrixWorldInverse.copy(Ws).invert();const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateMatrixWorld()}}}updateWorldMatrix(e,t){this.parent&&e&&this.parent.updateWorldMatrix(e,!1),this.updateMatrixWorld(!0)}}const Xs=new we,Ys=new R,Qs=[];function $s(e,t){return e.distance-t.distance}function Js(e,t,s,n){const{scene:r}=e.cached;s.invokeOnePlugin(s=>s.raycastTile&&s.raycastTile(e,r,t,n))||t.intersectObject(r,!0,n)}function Zs(e){return"__used"in e}function en(e,t,s,n=null){const{group:r,activeTiles:i}=e;null===n&&(n=Xs).copy(s.ray).applyMatrix4(r.matrixWorldInverse);const o=[],a=t.children;for(let h=0,u=a.length;h<u;h++){const e=a[h];if(!Zs(e)||!e.__used)continue;null!==e.cached.boundingVolume.intersectRay(n,Ys)&&(Ys.applyMatrix4(r.matrixWorld),o.push({distance:Ys.distanceToSquared(s.ray.origin),tile:e}))}o.sort($s);let l=null,c=1/0;if(i.has(t)){const n=function(e,t,s){Js(e,t,s,Qs),Qs.sort($s);const n=Qs[0]||null;return Qs.length=0,n}(t,s,e);n&&(l=n,c=n.distance*n.distance)}for(let h=0,u=o.length;h<u;h++){const t=o[h],r=t.distance,i=t.tile;if(r>c)break;const a=en(e,i,s,n);if(a){const e=a.distance*a.distance;e<c&&(l=a,c=e)}}return l}function tn(e,t,s,n,r=null){if(!Zs(t))return;const{group:i,activeTiles:o}=e,{boundingVolume:a}=t.cached;if(null===r&&(r=Xs).copy(s.ray).applyMatrix4(i.matrixWorldInverse),!t.__used||!a.intersectsRay(r))return;o.has(t)&&Js(t,s,e,n);const l=t.children;for(let c=0,h=l.length;c<h;c++)tn(e,l[c],s,n,r)}const sn=new R,nn=new R,rn=new R,on=new we;class an{constructor(e=new ye,t=new w){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new w,this.points=new Array(8).fill().map(()=>new R),this.planes=new Array(6).fill().map(()=>new Ee)}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return(new this.constructor).copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,rn).distanceTo(e)}containsPoint(e){return rn.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(rn)}intersectsRay(e){return on.copy(e).applyMatrix4(this.inverseTransform),on.intersectsBox(this.box)}intersectRay(e,t){return on.copy(e).applyMatrix4(this.inverseTransform),on.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:i}=n;let o=0;for(let a=-1;a<=1;a+=2)for(let t=-1;t<=1;t+=2)for(let n=-1;n<=1;n+=2)e[o].set(a<0?r.x:i.x,t<0?r.y:i.y,n<0?r.z:i.z).applyMatrix4(s),o++;this.updatePlanes()}updatePlanes(){sn.copy(this.box.min).applyMatrix4(this.transform),nn.copy(this.box.max).applyMatrix4(this.transform),rn.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(rn,sn),this.planes[1].setFromNormalAndCoplanarPoint(rn,nn).negate(),rn.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(rn,sn),this.planes[3].setFromNormalAndCoplanarPoint(rn,nn).negate(),rn.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(rn,sn),this.planes[5].setFromNormalAndCoplanarPoint(rn,nn).negate()}intersectsSphere(e){return this.clampPoint(e.center,rn),rn.distanceToSquared(e.center)<=e.radius*e.radius}intersectsFrustum(e){return this._intersectsPlaneShape(e.planes,e.points)}intersectsOBB(e){return this._intersectsPlaneShape(e.planes,e.points)}_intersectsPlaneShape(e,t){const s=this.points,n=this.planes;for(let r=0;r<6;r++){const t=e[r];let n=-1/0;for(let e=0;e<8;e++){const r=s[e],i=t.distanceToPoint(r);n=n<i?i:n}if(n<0)return!1}for(let r=0;r<6;r++){const e=n[r];let s=-1/0;for(let n=0;n<8;n++){const r=t[n],i=e.distanceToPoint(r);s=s<i?i:s}if(s<0)return!1}return!0}}const ln=Math.PI,cn=ln/2,hn=new R,un=new R,dn=new R,pn=new w;let mn=0;const fn=[];function gn(e=!1){return e?(fn[mn]||(fn[mn]=new R),mn++,fn[mn-1]):new R}function _n(){mn=0}class Tn extends Ps{constructor(e,t,s,n=-cn,r=cn,i=0,o=2*ln,a=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=r,this.lonStart=i,this.lonEnd=o,this.heightStart=a,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:r,heightStart:i,heightEnd:o}=this,a=re.mapLinear(.5,0,1,t,s),l=re.mapLinear(.5,0,1,n,r),c=Math.floor(n/cn)*cn,h=[[-ln/2,0],[ln/2,0],[0,c],[0,c+ln/2],[0,c+ln],[0,c+3*ln/2],[t,r],[s,r],[t,n],[s,n],[0,n],[0,r],[a,l],[t,l],[s,l],[a,n],[a,r]],u=[],d=h.length;for(let p=0;p<=1;p++){const a=re.mapLinear(p,0,1,i,o);for(let i=0,o=d;i<o;i++){const[o,l]=h[i];if(o>=t&&o<=s&&l>=n&&l<=r){const t=gn(e);u.push(t),this.getCartographicToPosition(o,l,a,t)}}}return u}getBoundingBox(e,t){_n();const{latStart:s,latEnd:n,lonStart:r,lonEnd:i}=this;if(n-s<ln/2){const e=re.mapLinear(.5,0,1,s,n),o=re.mapLinear(.5,0,1,r,i);this.getCartographicToNormal(e,o,dn),un.set(0,0,1),hn.crossVectors(un,dn),un.crossVectors(hn,dn),t.makeBasis(hn,un,dn)}else hn.set(1,0,0),un.set(0,1,0),dn.set(0,0,1),t.makeBasis(hn,un,dn);pn.copy(t).invert();const o=this._getPoints(!0);for(let a=0,l=o.length;a<l;a++)o[a].applyMatrix4(pn);e.makeEmpty(),e.setFromPoints(o)}getBoundingSphere(e,t){_n();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const yn=new R,bn=new R,An=new R,xn=new R,wn=new R;class Rn{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t))&&!(s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,i=-1/0;s&&e.intersectSphere(s,xn)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(xn)),n&&n.intersectRay(e,wn)&&(i=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(wn));const o=Math.max(r,i);return o===-1/0?null:(e.at(Math.sqrt(o),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsFrustum(e))&&Boolean(s||t))}intersectsSphere(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!s.intersectsSphere(e))&&(!(t&&!t.intersectsSphere(e))&&Boolean(s||t))}intersectsOBB(e){const t=this.obb||this.regionObb,s=this.sphere;return!(s&&!e.intersectsSphere(s))&&(!(t&&!t.intersectsOBB(e))&&Boolean(s||t))}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new an;yn.set(e[3],e[4],e[5]),bn.set(e[6],e[7],e[8]),An.set(e[9],e[10],e[11]);const n=yn.length(),r=bn.length(),i=An.length();yn.normalize(),bn.normalize(),An.normalize(),0===n&&yn.crossVectors(bn,An),0===r&&bn.crossVectors(yn,An),0===i&&An.crossVectors(yn,bn),s.transform.set(yn.x,bn.x,An.x,e[0],yn.y,bn.y,An.y,e[1],yn.z,bn.z,An.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-i),s.box.max.set(n,r,i),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const i=new be;i.center.set(e,t,s),i.radius=n,i.applyMatrix4(r),this.sphere=i}setRegionData(e,t,s,n,r,i,o){const a=new Tn(...e.radius,s,r,t,n,i,o),l=new an;a.getBoundingBox(l.box,l.transform),l.update(),this.region=a,this.regionObb=l}}const En=new Se;class vn extends ve{constructor(){super(),this.points=Array(8).fill().map(()=>new R)}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((e,s)=>{!function(e,t,s,n){const r=En.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,s.normal.x,s.normal.y,s.normal.z);n.set(-e.constant,-t.constant,-s.constant),n.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[s])})}}function Sn(e){const{TextureUtils:t}=Le;if(!t||!e)return 0;const{format:s,type:n,image:r}=e,{width:i,height:o}=r;let a=t.getByteLength(i,o,s,n);return a*=e.generateMipmaps?4/3:1,a}const Ln=new w,Cn=new Re,Pn=Symbol("INITIAL_FRUSTUM_CULLED"),Mn=new w,In=new R,On=new g,Fn={inView:!1,error:1/0},Nn=new R(1,0,0),Un=new R(0,1,0);function kn(e,t){e.traverse(e=>{e.frustumCulled=e[Pn]&&t})}class Dn extends Je{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{kn(t,!e)}))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new qs(this),this.ellipsoid=Ms.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new w,this._bytesUsed=new WeakMap,this._autoDisableRendererCulling=!0;const t=new Ce;t.setURLModifier(e=>this.preprocessURL?this.preprocessURL(e):e),this.manager=t,this._listeners={}}addEventListener(...e){Pe.prototype.addEventListener.call(this,...e)}hasEventListener(...e){Pe.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){Pe.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){Pe.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return!!s&&(s.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached&&t.cached.scene;s&&e(s,t)},null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=en(this,this.root,e);s&&t.push(s)}else tn(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return!s.has(e)&&(s.set(e,new g),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,i=t.isVector2?t.y:s,o=n.get(e);return o.width===r&&o.height===i||(o.set(r,i),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(On),this.setResolution(e,On.x,On.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(e=>{const{asset:t,extensions:s={}}=e;switch((t&&t.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Un,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Nn,Math.PI/2)}if("3DTILES_ellipsoid"in s){const e=s["3DTILES_ellipsoid"],{ellipsoid:t}=this;t.name=e.body,e.radii?t.radius.set(...e.radii):t.radius.set(1,1,1)}return e})}update(){let e=null;if(this.invokeAllPlugins(t=>{if(t.doTilesNeedUpdate){const s=t.doTilesNeedUpdate();e=null===e?s:Boolean(e||s)}}),!1===e)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,r=this.cameraInfo;for(;r.length>s.length;)r.pop();for(;r.length<s.length;)r.push({frustum:new vn,isOrthographic:!1,sseDenominator:-1,position:new R,invScale:-1,pixelSize:0});In.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(In.x-In.y,In.x-In.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let i=0,o=r.length;i<o;i++){const e=s[i],o=r[i],a=o.frustum,l=o.position,c=n.get(e);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=e.projectionMatrix.elements;if(o.isOrthographic=1===h[15],o.isOrthographic){const e=2/h[0],t=2/h[5];o.pixelSize=Math.max(t/c.height,e/c.width)}else o.sseDenominator=2/h[5]/c.height;Mn.copy(t.matrixWorld),Mn.premultiply(e.matrixWorldInverse),Mn.premultiply(e.projectionMatrix),a.setFromProjectionMatrix(Mn),l.set(0,0,0),l.applyMatrix4(e.matrixWorld),l.applyMatrix4(t.matrixWorldInverse)}if(super.update(),this.dispatchEvent({type:"update-after"}),0===s.length&&this.root){let e=!1;this.invokeAllPlugins(t=>e=e||Boolean(t!==this&&t.calculateTileViewError)),!1===e&&console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new w;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)n.elements[e]=t[e]}s&&n.premultiply(s.cached.transform);const r=(new w).copy(n).invert(),i=new Rn;"sphere"in e.boundingVolume&&i.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&i.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&i.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:r,active:!1,boundingVolume:i,metadata:null,scene:null,geometry:null,materials:null,textures:null}}parseTile(e,t,s,n,r){return l(this,null,function*(){const i=t.cached,o=n.split(/[\\/]/g);o.pop();const a=o.join("/"),l=this.fetchOptions,c=this.manager;let h=null;const u=i.transform,d=this._upRotationMatrix,p=(ot(e)||s).toLowerCase();switch(p){case"b3dm":{const t=new hs(c);t.workingPath=a,t.fetchOptions=l,t.adjustmentTransform.copy(d),h=t.parse(e);break}case"pnts":{const t=new fs(c);t.workingPath=a,t.fetchOptions=l,h=t.parse(e);break}case"i3dm":{const t=new zs(c);t.workingPath=a,t.fetchOptions=l,t.adjustmentTransform.copy(d),t.ellipsoid.copy(this.ellipsoid),h=t.parse(e);break}case"cmpt":{const t=new Ks(c);t.workingPath=a,t.fetchOptions=l,t.adjustmentTransform.copy(d),t.ellipsoid.copy(this.ellipsoid),h=t.parse(e).then(e=>e.scene);break}case"gltf":case"glb":{const t=c.getHandler("path.gltf")||c.getHandler("path.glb")||new dt(c);t.setWithCredentials("include"===l.credentials),t.setRequestHeader(l.headers||{}),"include"===l.credentials&&"cors"===l.mode&&t.setCrossOrigin("use-credentials");let s=t.resourcePath||t.path||a;!/[\\/]$/.test(s)&&s.length&&(s+="/"),h=t.parseAsync(e,s).then(e=>{e.scene=e.scene||new se;const{scene:t}=e;return t.updateMatrix(),t.matrix.multiply(d).decompose(t.position,t.quaternion,t.scale),e});break}default:h=this.invokeOnePlugin(i=>i.parseToMesh&&i.parseToMesh(e,t,s,n,r))}const m=yield h;if(null===m)throw new Error(`TilesRenderer: Content type "${p}" not supported.`);let f,g;m.isObject3D?(f=m,g=null):(f=m.scene,g=m),f.updateMatrix(),f.matrix.premultiply(u),f.matrix.decompose(f.position,f.quaternion,f.scale),yield this.invokeAllPlugins(e=>e.processTileModel&&e.processTileModel(f,t)),f.traverse(e=>{e[Pn]=e.frustumCulled}),kn(f,!this.autoDisableRendererCulling);const _=[],T=[],y=[];if(f.traverse(e=>{if(e.geometry&&T.push(e.geometry),e.material){const t=e.material;_.push(e.material);for(const e in t){const s=t[e];s&&s.isTexture&&y.push(s)}}}),r.aborted)for(let e=0,t=y.length;e<t;e++){const t=y[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}else i.materials=_,i.geometry=T,i.textures=y,i.scene=f,i.metadata=g})}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,i=t.scene.parent;t.scene.traverse(e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()});for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=s.length;e<t;e++)s[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}i&&i.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateBytesUsed(e,t){var s;const n=this._bytesUsed;return!n.has(e)&&t&&n.set(e,function(e){const t=new Set;let s=0;return e.traverse(e=>{if(e.geometry&&!t.has(e.geometry)&&(s+=function(e){let t=0;for(const n in e.attributes){const s=e.getAttribute(n);t+=s.count*s.itemSize*s.array.BYTES_PER_ELEMENT}const s=e.getIndex();return t+=s?s.count*s.itemSize*s.array.BYTES_PER_ELEMENT:0,t}(e.geometry),t.add(e.geometry)),e.material){const n=e.material;for(const e in n){const r=n[e];r&&r.isTexture&&!t.has(r)&&(s+=Sn(r),t.add(r))}}}),s}(t)),null!=(s=n.get(e))?s:null}calculateTileViewError(e,t){const s=e.cached,n=this.cameras,r=this.cameraInfo,i=s.boundingVolume;let o=!1,a=-1/0,l=1/0,c=-1/0,h=1/0;for(let u=0,d=n.length;u<d;u++){const t=r[u];let s,n;if(t.isOrthographic){const r=t.pixelSize;s=e.geometricError/r,n=1/0}else{const r=t.sseDenominator;n=i.distanceToPoint(t.position),s=0===n?1/0:e.geometricError/(n*r)}const d=r[u].frustum;i.intersectsFrustum(d)&&(o=!0,a=Math.max(a,s),l=Math.min(l,n)),c=Math.max(c,s),h=Math.min(h,n)}this.invokeAllPlugins(t=>{t!==this&&t.calculateTileViewError&&(t.calculateTileViewError(e,Fn),Fn.inView&&(o=!0,a=Math.max(a,Fn.error)),c=Math.max(c,Fn.error))}),o?(t.inView=!0,t.error=a,t.distanceFromCamera=l):(t.inView=!1,t.error=c,t.distanceFromCamera=h)}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:n}=this;Cn.set(Math.PI/2,Math.PI/2,0),Ln.makeRotationFromEuler(Cn),s.getEastNorthUpFrame(e,t,0,n.matrix).multiply(Ln).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}export{Dn as T};
