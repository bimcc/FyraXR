import{U as p,ab as u,am as m,W as f,an as g,ao as y,ap as R,aq as w,D as v,ar as b,as as d,E as h,at as E}from"./three-le7vLHvZ.js";import{T as C}from"./3d-tiles-av-1eJj6.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class M extends EventTarget{constructor(e,t,i){super(),this.renderer=e,this.scene=t,this.camera=i,this.session=null,this.isSupported=!1,this.checkARSupport()}async checkARSupport(){"xr"in navigator?(this.isSupported=await navigator.xr.isSessionSupported("immersive-ar"),console.log("AR Support:",this.isSupported)):console.log("WebXR not supported")}async startARSession(){if(!this.isSupported)throw new Error("AR not supported");try{this.session=await navigator.xr.requestSession("immersive-ar",{requiredFeatures:["local-floor"],optionalFeatures:["dom-overlay"],domOverlay:{root:document.getElementById("ui-overlay")}}),await this.renderer.xr.setSession(this.session),this.dispatchEvent(new Event("sessionstart"))}catch(e){throw console.error("Failed to start AR session:",e),e}}endARSession(){this.session&&(this.session.end(),this.session=null,this.dispatchEvent(new Event("sessionend")))}}class S{constructor(){this.calibrationData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},this.loadCalibration()}setPosition(e,t,i){this.calibrationData.position={x:e,y:t,z:i}}setRotation(e,t,i){this.calibrationData.rotation={x:e,y:t,z:i}}setScale(e,t,i){this.calibrationData.scale={x:e,y:t,z:i}}getCalibrationData(){return this.calibrationData}saveCalibration(){localStorage.setItem("fyraxr-calibration",JSON.stringify(this.calibrationData)),console.log("Calibration saved:",this.calibrationData)}loadCalibration(){const e=localStorage.getItem("fyraxr-calibration");e&&(this.calibrationData=JSON.parse(e),console.log("Calibration loaded:",this.calibrationData))}resetCalibration(){this.calibrationData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1}},this.saveCalibration()}}class x{constructor(e){this.app=e,this.isCollapsed=!1,this.setupEventListeners(),this.setupPanelCollapse()}setupEventListeners(){const e=document.getElementById("ar-button");e&&e.addEventListener("click",()=>this.toggleAR());const t=document.getElementById("calibrate-button");t&&t.addEventListener("click",()=>this.toggleCalibration());const i=document.getElementById("reset-position");i&&i.addEventListener("click",()=>this.resetPosition());const s=document.getElementById("save-calibration");s&&s.addEventListener("click",()=>this.saveCalibration());const a=document.getElementById("close-calibration");a&&a.addEventListener("click",()=>this.closeCalibration());const n=document.getElementById("apply-calibration");n&&n.addEventListener("click",()=>this.applyCalibration());const o=document.getElementById("opacity-slider");o&&o.addEventListener("input",l=>this.updateOpacity(l.target.value));const c=document.getElementById("scale-slider");c&&c.addEventListener("input",l=>this.updateScale(l.target.value)),this.setupCalibrationSliders()}setupPanelCollapse(){const e=document.getElementById("collapse-btn"),t=document.getElementById("panel-content"),i=document.getElementById("panel-header");e&&t&&(e.addEventListener("click",s=>{s.stopPropagation(),this.togglePanelCollapse()}),i.addEventListener("click",()=>{this.togglePanelCollapse()}))}togglePanelCollapse(){const e=document.getElementById("collapse-btn"),t=document.getElementById("panel-content");this.isCollapsed=!this.isCollapsed,this.isCollapsed?(t.classList.add("collapsed"),e.textContent="+"):(t.classList.remove("collapsed"),e.textContent="−")}setupCalibrationSliders(){[{id:"offset-x",valueId:"offset-x-value"},{id:"offset-y",valueId:"offset-y-value"},{id:"offset-z",valueId:"offset-z-value"},{id:"rotation-y",valueId:"rotation-y-value",suffix:"°"}].forEach(t=>{const i=document.getElementById(t.id),s=document.getElementById(t.valueId);i&&s&&i.addEventListener("input",a=>{const n=a.target.value;s.textContent=n+(t.suffix||"")})})}async toggleAR(){try{this.app.isARActive?this.app.arManager.endARSession():await this.app.arManager.startARSession()}catch(e){console.error("AR toggle failed:",e),this.updateARStatus("AR启动失败")}}toggleCalibration(){const e=document.getElementById("calibration-panel");e&&(e.style.display=e.style.display==="none"?"block":"none")}closeCalibration(){const e=document.getElementById("calibration-panel");e&&(e.style.display="none")}applyCalibration(){const e=parseFloat(document.getElementById("offset-x").value),t=parseFloat(document.getElementById("offset-y").value),i=parseFloat(document.getElementById("offset-z").value),s=parseFloat(document.getElementById("rotation-y").value);this.app.calibrationManager.applyCalibration({offset:{x:e,y:t,z:i},rotation:{y:s}}),this.updateARStatus("标定已应用")}resetPosition(){this.app.calibrationManager.resetCalibration(),this.updateARStatus("位置已重置"),document.getElementById("offset-x").value=0,document.getElementById("offset-y").value=0,document.getElementById("offset-z").value=0,document.getElementById("rotation-y").value=0,document.getElementById("offset-x-value").textContent="0",document.getElementById("offset-y-value").textContent="0",document.getElementById("offset-z-value").textContent="0",document.getElementById("rotation-y-value").textContent="0°"}saveCalibration(){this.app.calibrationManager.saveCalibration(),this.updateARStatus("标定已保存")}updateOpacity(e){const t=document.getElementById("opacity-value");t&&(t.textContent=e),this.app.tilesManager&&this.app.tilesManager.setOpacity&&this.app.tilesManager.setOpacity(parseFloat(e))}updateScale(e){const t=document.getElementById("scale-value");t&&(t.textContent=e),this.app.tilesManager&&this.app.tilesManager.scaleModel&&this.app.tilesManager.scaleModel(parseFloat(e))}updateARStatus(e){const t=document.getElementById("ar-status");t&&(t.textContent=e)}updateTilesStatus(e){const t=document.getElementById("tiles-status");t&&(t.textContent=e)}showPanel(){const e=document.getElementById("control-panel");e&&(e.style.display="block")}hidePanel(){const e=document.getElementById("control-panel");e&&(e.style.display="none")}}class A{constructor(e,t,i){this.scene=e,this.camera=t,this.renderer=i,this.tilesRenderer=null,this.group=new p,this.scene.add(this.group)}async loadTileset(e){console.log("开始加载tileset:",e);try{const t=async i=>{try{const s=await fetch(i,{method:"HEAD",cache:"no-cache"});return s.ok?(console.log(`✅ 资源可访问: ${i}`),new C(i)):(console.warn(`❌ 资源不可访问 (${s.status}): ${i}`),null)}catch(s){return console.warn(`❌ 检查资源失败: ${i}`,s),null}};if(this.tilesRenderer=await t(e),!this.tilesRenderer){console.log("直接URL加载失败，尝试其他路径...");const s=["./models/mj/tileset.json","../models/mj/tileset.json",`${window.location.pathname.includes("/FyraXR/")?"/FyraXR/":"/"}models/mj/tileset.json`,"/FyraXR/models/mj/tileset.json"];for(const a of s)if(console.log(`尝试备用路径: ${a}`),this.tilesRenderer=await t(a),this.tilesRenderer){console.log(`✅ 成功使用备用路径: ${a}`);break}if(!this.tilesRenderer)throw new Error("所有路径尝试失败")}return this.tilesRenderer.setCamera(this.camera),this.tilesRenderer.setResolutionFromRenderer(this.camera,this.renderer),this.tilesRenderer.addEventListener("load-tile-set",()=>{console.log("Tileset加载完成!"),this.optimizeModelView()}),this.tilesRenderer.addEventListener("load-tile-set-failed",i=>{console.error("Tileset加载失败:",i)}),this.group.add(this.tilesRenderer.group),console.log("TilesRenderer已创建并添加到场景"),Promise.resolve()}catch(t){throw console.error("创建TilesRenderer时出错:",t),t}}optimizeModelView(){if(!this.tilesRenderer)return;const e=new u;this.tilesRenderer.getBoundingSphere(e),console.log("模型边界球:",e),this.tilesRenderer.group.position.copy(e.center).multiplyScalar(-1);const t=e.radius,s=Math.max(t,50),a=s*3.5,n=s*2,o=s*2;this.camera.position.set(o,n,a),this.camera.lookAt(0,0,0),this.camera.near=s*.01,this.camera.far=s*100,this.camera.updateProjectionMatrix(),console.log("相机位置已优化:",this.camera.position),console.log("模型半径:",t,"有效半径:",s),console.log("相机距离:",a)}update(){this.tilesRenderer&&(this.camera.updateMatrixWorld(),this.tilesRenderer.update())}centerCamera(){this.optimizeModelView(),console.log("相机已手动重新居中到模型")}scaleModel(e){this.tilesRenderer&&(this.tilesRenderer.group.scale.setScalar(e),console.log("模型缩放因子设置为:",e))}resetView(){this.tilesRenderer&&(this.tilesRenderer.group.scale.setScalar(1),this.optimizeModelView(),console.log("视图已重置"))}}class I{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.arManager=null,this.calibrationManager=null,this.uiController=null,this.tilesManager=null,this.isARActive=!1,this.animationId=null,this.init()}async init(){try{this.setupThreeJS(),this.setupManagers(),this.setupEventListeners(),await this.loadDefaultTileset(),this.startRenderLoop(),console.log("FyraXR应用初始化完成")}catch(e){console.error("应用初始化失败:",e)}}setupThreeJS(){this.scene=new m,this.camera=new f(75,window.innerWidth/window.innerHeight,.1,1e4),this.camera.position.set(0,5,10),this.renderer=new g({antialias:!0,alpha:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=y,this.renderer.xr.enabled=!0,document.getElementById("container").appendChild(this.renderer.domElement),this.controls=new R(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.maxPolarAngle=Math.PI;const e=new w(16777215,.6);this.scene.add(e);const t=new v(16777215,.8);t.position.set(50,50,50),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,this.scene.add(t)}setupManagers(){this.arManager=new M(this.renderer,this.scene,this.camera),this.calibrationManager=new S,this.uiController=new x(this),this.tilesManager=new A(this.scene,this.camera,this.renderer)}setupEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),this.arManager.addEventListener("sessionstart",()=>{this.isARActive=!0,this.uiController.updateARStatus("AR已启动"),console.log("AR会话已启动")}),this.arManager.addEventListener("sessionend",()=>{this.isARActive=!1,this.uiController.updateARStatus("AR已结束"),console.log("AR会话已结束")})}async loadDefaultTileset(){try{const e=window.location.pathname.includes("/FyraXR/")?"/FyraXR":"";console.log("🌐 Tileset加载基础路径:",e),await this.tilesManager.loadTileset(`${e}/models/mj/tileset.json`),this.uiController.updateTilesStatus("3D Tiles加载完成"),console.log("3D Tiles模型加载成功!");return}catch(e){console.warn("所有tileset加载尝试失败:",e),this.createExampleGeometry(),this.uiController.updateTilesStatus("使用示例几何体 (模型加载失败)")}}createExampleGeometry(){const e=new b(2,2,2),t=new d({color:65280,transparent:!0,opacity:.8}),i=new h(e,t);i.position.set(0,1,-5),this.scene.add(i);for(let s=0;s<5;s++){const a=new E(.5,16,16),n=new d({color:Math.random()*16777215,transparent:!0,opacity:.7}),o=new h(a,n);o.position.set((Math.random()-.5)*10,Math.random()*3,-5+(Math.random()-.5)*5),this.scene.add(o)}}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.controls&&this.controls.update()}startRenderLoop(){const e=()=>{this.animationId=this.renderer.setAnimationLoop(e),this.controls&&!this.isARActive&&this.controls.update(),this.tilesManager.tilesRenderer&&(this.camera.updateMatrixWorld(),this.tilesManager.tilesRenderer.update()),this.renderer.render(this.scene,this.camera)};e()}async startAR(){try{this.controls&&(this.controls.enabled=!1),await this.arManager.startARSession()}catch(e){console.error("启动AR失败:",e),alert("启动AR失败: "+e.message),this.controls&&(this.controls.enabled=!0)}}stopAR(){this.arManager.stopARSession(),this.controls&&(this.controls.enabled=!0)}applyCalibration(e){this.calibrationManager.applyCalibration(this.scene,e)}resetPosition(){this.calibrationManager.resetPosition(this.scene)}}const B=new I;window.fyraxrApp=B;
