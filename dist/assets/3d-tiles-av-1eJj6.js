import{T as Ps,a as tt,b as Wt,L as Is,c as fe,F as Xt,M as B,V as ge,C as $,d as z,S as pe,e as Ns,P as Fs,D as Os,f as C,g as S,I as Qt,Q as Ie,h as vs,O as Yt,i as Us,j as Ds,B as D,k as Bs,l as $t,N as ks,m as Vs,n as Hs,o as Jt,p as Gs,R as st,q as js,r as zs,s as Zt,t as De,u as Ks,v as es,w as qs,x as he,y as Ws,z as ts,A as Xs,E as Qs,G as Ys,H as $s,J as Js,K as ss,U as ne,W as Zs,X as Q,Y as en,Z as tn,_ as sn,$ as nn,a0 as rn,a1 as ns,a2 as on,a3 as ft,a4 as pt,a5 as mt,a6 as gt,a7 as Tt,a8 as an,a9 as cn,aa as rs,ab as ot,ac as Ne,ad as is,ae as at,af as os,ag as ln,ah as un,ai as hn,aj as dn,ak as fn,al as Te}from"./three-le7vLHvZ.js";function _t(c){if(!c)return null;const e=c.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),t=e.lastIndexOf(".");return t===-1?null:e.substring(t+1)||null}const yt=2**30;class pn{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),i=e(s);return n<i?-1:n>i?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*yt,this.maxBytesSize=.4*yt,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)||0}setMemoryUsage(e,t){const{bytesMap:s,itemSet:n}=this;n.has(e)&&(this.cachedBytes-=s.get(e)||0,s.set(e,t),this.cachedBytes+=t)}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,i=this.itemList,r=this.callbacks;return i.push(e),n.add(e),s.set(e,Date.now()),r.set(e,t),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,i=this.bytesMap,r=this.callbacks,o=this.loadedSet;if(s.has(e)){this.cachedBytes-=i.get(e)||0,i.delete(e),r.get(e)(e);const a=n.indexOf(e);return n.splice(a,1),t.delete(e),s.delete(e),r.delete(e),o.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(t===!0?n.add(e):n.delete(e))}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:i,usedSet:r,loadedSet:o,callbacks:a,bytesMap:l,minBytesSize:u,maxBytesSize:h}=this,d=n.length-r.size,f=n.length-o.size,p=Math.max(Math.min(n.length-t,d),0),g=this.cachedBytes-u,m=this.unloadPriorityCallback||this.defaultPriorityCallback;let _=!1;const y=p>0&&d>0||f&&n.length>s;if(d&&this.cachedBytes>u||f&&this.cachedBytes>h||y){n.sort((L,P)=>{const F=r.has(L),Ue=r.has(P);if(F===Ue){const dt=o.has(L),Cs=o.has(P);return dt===Cs?-m(L,P):dt?1:-1}else return F?1:-1});const b=Math.max(t*e,p*e),T=Math.ceil(Math.min(b,d,p)),w=Math.max(e*g,e*u),E=Math.min(w,g);let x=0,A=0;for(;this.cachedBytes-A>h||n.length-x>s;){const L=n[x],P=l.get(L)||0;if(r.has(L)&&o.has(L)||this.cachedBytes-A-P<h&&n.length-x<=s)break;A+=P,x++}for(;A<E||x<T;){const L=n[x],P=l.get(L)||0;if(r.has(L)||this.cachedBytes-A-P<u&&x>=T)break;A+=P,x++}n.splice(0,x).forEach(L=>{this.cachedBytes-=l.get(L)||0,a.get(L)(L),l.delete(L),i.delete(L),a.delete(L),o.delete(L),r.delete(L)}),_=x<p||A<g&&x<d,_=_&&x>0}_&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class Be{get running(){return this.items.length!==0||this.currJobs!==0}constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback;this.items.sort(e)}has(e){return this.callbacks.has(e)}add(e,t){const s={callback:t,reject:null,resolve:null,promise:null};return s.promise=new Promise((n,i)=>{const r=this.items,o=this.callbacks;s.resolve=n,s.reject=i,r.push(e),o.set(e,s),this.autoUpdate&&this.scheduleJobRun()}),s.promise}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);if(n!==-1){const i=s.get(e);i.promise.catch(()=>{}),i.reject(new Error("PriorityQueue: Item removed.")),t.splice(n,1),s.delete(e)}}removeByFilter(e){const{items:t}=this;for(let s=0;s<t.length;s++){const n=t[s];e(n)&&this.remove(n)}}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=0;const i=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&e.length>0&&n<s;){this.currJobs++,n++;const r=e.pop(),{callback:o,resolve:a,reject:l}=t.get(r);t.delete(r);let u;try{u=o(r)}catch(h){l(h),i()}u instanceof Promise?u.then(a).catch(l).finally(i):(a(u),i())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const se=-1,G=0,_e=1,ke=2,me=3,At=6378137,mn=6356752314245179e-9,ye={inView:!1,error:1/0,distanceFromCamera:1/0};function as(c){return c===me||c===se}function Y(c,e){return c.__lastFrameVisited===e&&c.__used}function ct(c){return c.__childrenProcessed===c.children.length}function lt(c,e){c.__lastFrameVisited!==e.frameCount&&(c.__lastFrameVisited=e.frameCount,c.__used=!1,c.__inFrustum=!1,c.__isLeaf=!1,c.__visible=!1,c.__active=!1,c.__error=1/0,c.__distanceFromCamera=1/0,c.__childrenWereVisible=!1,c.__allChildrenLoaded=!1,e.calculateTileViewError(c,ye),c.__inFrustum=ye.inView,c.__error=ye.error,c.__distanceFromCamera=ye.distanceFromCamera)}function cs(c,e){if(e.ensureChildrenArePreprocessed(c),lt(c,e),nt(c,e),!c.__hasRenderableContent&&ct(c)){const t=c.children;for(let s=0,n=t.length;s<n;s++)cs(t[s],e)}}function ls(c,e){if(e.ensureChildrenArePreprocessed(c),Y(c,e.frameCount)&&(c.__hasContent&&c.__loadingState===G&&!e.lruCache.isFull()&&e.queueTileForDownload(c),ct(c))){const t=c.children;for(let s=0,n=t.length;s<n;s++)ls(t[s],e)}}function nt(c,e){c.__used||(c.__used=!0,e.markTileUsed(c),e.stats.used++,c.__inFrustum===!0&&e.stats.inFrustum++)}function gn(c,e){return!(c.__error<=e.errorTarget||e.maxDepth>0&&c.__depth+1>=e.maxDepth||!ct(c))}function Tn(c,e=null,t=null){const s=[];for(s.push(c),s.push(null),s.push(0);s.length>0;){const n=s.pop(),i=s.pop(),r=s.pop();if(e&&e(r,i,n)){t&&t(r,i,n);return}const o=r.children;if(o)for(let a=o.length-1;a>=0;a--)s.push(o[a]),s.push(r),s.push(n+1);t&&t(r,i,n)}}function us(c,e){if(e.ensureChildrenArePreprocessed(c),lt(c,e),!c.__inFrustum)return;if(!gn(c,e)){nt(c,e);return}let t=!1,s=!1;const n=c.children;for(let i=0,r=n.length;i<r;i++){const o=n[i];us(o,e),t=t||Y(o,e.frameCount),s=s||o.__inFrustum}if(nt(c,e),t&&c.refine==="REPLACE")for(let i=0,r=n.length;i<r;i++){const o=n[i];cs(o,e)}}function hs(c,e){const t=e.frameCount;if(!Y(c,t))return;const s=c.children;let n=!1;for(let i=0,r=s.length;i<r;i++){const o=s[i];n=n||Y(o,t)}if(!n)c.__isLeaf=!0;else{let i=!1,r=!0;for(let o=0,a=s.length;o<a;o++){const l=s[o];if(hs(l,e),i=i||l.__wasSetVisible||l.__childrenWereVisible,Y(l,t)){const u=l.__allChildrenLoaded||l.__hasRenderableContent&&as(l.__loadingState)||!l.__hasContent&&l.children.length===0||l.__hasUnrenderableContent&&l.__loadingState===se;r=r&&u}}c.__childrenWereVisible=i,c.__allChildrenLoaded=r}}function ds(c,e){const t=e.stats;if(!Y(c,e.frameCount))return;const s=e.lruCache;if(c.__isLeaf){c.__loadingState===me?(c.__inFrustum&&(c.__visible=!0,t.visible++),c.__active=!0,t.active++):!s.isFull()&&c.__hasContent&&e.queueTileForDownload(c);return}const n=c.children,i=c.__hasContent,r=as(c.__loadingState)&&i,o=(e.errorTarget+1)*e.errorThreshold,a=c.__error<=o,l=c.__childrenWereVisible,u=c.__allChildrenLoaded;if((a||c.refine==="ADD")&&!r&&!s.isFull()&&i&&e.queueTileForDownload(c),(a&&!u&&!l&&r||c.refine==="ADD"&&r)&&(c.__inFrustum&&(c.__visible=!0,t.visible++),c.__active=!0,t.active++),c.refine==="REPLACE"&&a&&!u)for(let d=0,f=n.length;d<f;d++){const p=n[d];Y(p,e.frameCount)&&ls(p,e)}else for(let d=0,f=n.length;d<f;d++)ds(n[d],e)}function fs(c,e){const t=Y(c,e.frameCount);if(t||c.__usedLastFrame){let s=!1,n=!1;t?(s=c.__active,e.displayActiveTiles?n=c.__active||c.__visible:n=c.__visible):lt(c,e),c.__hasRenderableContent&&c.__loadingState===me&&(c.__wasSetActive!==s&&e.invokeOnePlugin(r=>r.setTileActive&&r.setTileActive(c,s)),c.__wasSetVisible!==n&&e.invokeOnePlugin(r=>r.setTileVisible&&r.setTileVisible(c,n))),c.__wasSetActive=s,c.__wasSetVisible=n,c.__usedLastFrame=t;const i=c.children;for(let r=0,o=i.length;r<o;r++){const a=i[r];fs(a,e)}}}function _n(c){let e=null;return()=>{e===null&&(e=requestAnimationFrame(()=>{e=null,c()}))}}const bt=Symbol("PLUGIN_REGISTERED"),Ve=(c,e)=>{const t=c.priority||0,s=e.priority||0;return t!==s?t>s?1:-1:c.__depthFromRenderedParent!==e.__depthFromRenderedParent?c.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:c.__inFrustum!==e.__inFrustum?c.__inFrustum?1:-1:c.__used!==e.__used?c.__used?1:-1:c.__error!==e.__error?c.__error>e.__error?1:-1:c.__distanceFromCamera!==e.__distanceFromCamera?c.__distanceFromCamera>e.__distanceFromCamera?-1:1:0},yn=(c,e)=>{const t=c.priority||0,s=e.priority||0;return t!==s?t>s?1:-1:c.__depthFromRenderedParent!==e.__depthFromRenderedParent?c.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:c.__loadingState!==e.__loadingState?c.__loadingState>e.__loadingState?-1:1:c.__lastFrameVisited!==e.__lastFrameVisited?c.__lastFrameVisited>e.__lastFrameVisited?-1:1:c.__hasUnrenderableContent!==e.__hasUnrenderableContent?c.__hasUnrenderableContent?-1:1:c.__error!==e.__error?c.__error>e.__error?-1:1:0};class An{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const{stats:e,isLoading:t}=this,s=e.downloading+e.parsing,n=e.inCacheSinceLoad+(t?1:0);return n===0?1:1-s/n}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=G,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set,this.isLoading=!1;const t=new pn;t.unloadPriorityCallback=yn;const s=new Be;s.maxJobs=25,s.priorityCallback=Ve;const n=new Be;n.maxJobs=5,n.priorityCallback=Ve;const i=new Be;i.maxJobs=25,i.priorityCallback=Ve,i.log=!0,this.processedTiles=new WeakSet,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.processNodeQueue=i,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this._dispatchNeedsUpdateEvent=_n(()=>{this.dispatchEvent({type:"needs-update"})}),this.errorTarget=16,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[bt]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,s=e.priority||0;let n=t.length;for(let i=0;i<t.length;i++)if((t[i].priority||0)>s){n=i;break}t.splice(n,0,e),e[bt]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if(typeof e=="string"&&(e=this.getPluginByName(name)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(t=>t.name===e)||null}traverse(e,t,s=!0){this.root&&Tn(this.root,(n,...i)=>(s&&this.ensureChildrenArePreprocessed(n,!0),e?e(n,...i):!1),t)}queueTileForDownload(e){e.__loadingState===G&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:s,root:n,downloadQueue:i,parseQueue:r,processNodeQueue:o}=this;if(this.rootLoadingState===G&&(this.rootLoadingState=_e,this.invokeOnePlugin(u=>u.loadRootTileSet&&u.loadRootTileSet()).then(u=>{let h=this.rootURL;h!==null&&this.invokeAllPlugins(d=>h=d.preprocessURL?d.preprocessURL(h,null):h),this.rootLoadingState=me,this.rootTileSet=u,this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tile-set",tileSet:u,url:h})}).catch(u=>{this.rootLoadingState=se,console.error(u),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:u,url:this.rootURL})})),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach(u=>e.markUnused(u)),t.clear(),us(n,this),hs(n,this),ds(n,this),fs(n,this);const a=this.queuedTiles;a.sort(e.unloadPriorityCallback);for(let u=0,h=a.length;u<h&&!e.isFull();u++)this.requestTileContents(a[u]);a.length=0,e.scheduleUnload(),(i.running||r.running||o.running)===!1&&this.isLoading===!0&&(this.cachedSinceLoadComplete.clear(),s.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}),this.isLoading=!1)}resetFailedTiles(){this.rootLoadingState===se&&(this.rootLoadingState=G);const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===se&&(t.__loadingState=G)},null,!1),e.failed=0)}dispose(){[...this.plugins].forEach(n=>{this.unregisterPlugin(n)});const t=this.lruCache,s=[];this.traverse(n=>(s.push(n),!1),null,!1);for(let n=0,i=s.length;n<i;n++)t.remove(s[n]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}calculateBytesUsed(e,t){return 0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,!1)),e.__visible=!1),e.__active&&(this.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,!1)),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(this.processedTiles.add(e),e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],(n=e.content)!=null&&n.uri){const i=_t(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(i&&/json$/.test(i)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__childrenProcessed=0,s&&s.__childrenProcessed++,e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=G,s===null?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(i=>{i!==this&&i.preprocessNode&&i.preprocessNode(e,t,s)})}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateTileViewError(e,t){}ensureChildrenArePreprocessed(e,t=!1){const s=e.children;for(let n=0,i=s.length;n<i;n++){const r=s[n];if("__depth"in r)break;t?(this.processNodeQueue.remove(r),this.preprocessNode(r,e.__basePath,e)):this.processNodeQueue.has(r)||this.processNodeQueue.add(r,o=>{this.preprocessNode(o,e.__basePath,e),this._dispatchNeedsUpdateEvent()})}}getBytesUsed(e){let t=0;return this.invokeAllPlugins(s=>{s.calculateBytesUsed&&(t+=s.calculateBytesUsed(e,e.cached.scene)||0)}),t}recalculateBytesUsed(e=null){const{lruCache:t,processedTiles:s}=this;e===null?t.itemSet.forEach(n=>{s.has(n)&&t.setMemoryUsage(n,this.getBytesUsed(n))}):t.setMemoryUsage(e,this.getBytesUsed(e))}preprocessTileSet(e,t,s=null){const n=e.asset.version,[i,r]=n.split(".").map(a=>parseInt(a));console.assert(i<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),i===1&&r>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let o=t.replace(/\/[^/]*$/,"");o=new URL(o,window.location.href).toString(),this.preprocessNode(e.root,o,s)}loadRootTileSet(){let e=this.rootURL;return this.invokeAllPlugins(s=>e=s.preprocessURL?s.preprocessURL(e,null):e),this.invokeOnePlugin(s=>s.fetchData&&s.fetchData(e,this.fetchOptions)).then(s=>{if(s instanceof Response){if(s.ok)return s.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${s.status} : ${s.statusText}`)}else return s}).then(s=>(this.preprocessTileSet(s,e),s))}requestTileContents(e){if(e.__loadingState!==G)return;let t=!1,s=null,n=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(f=>n=f.preprocessURL?f.preprocessURL(n,e):n);const i=this.stats,r=this.lruCache,o=this.downloadQueue,a=this.parseQueue,l=_t(n),u=new AbortController,h=u.signal;if(r.add(e,f=>{u.abort(),t?(f.children.length=0,f.__childrenProcessed=0):this.invokeAllPlugins(p=>{p.disposeTile&&p.disposeTile(f)}),i.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),i.inCacheSinceLoad--),f.__loadingState===_e?i.downloading--:f.__loadingState===ke&&i.parsing--,f.__loadingState=G,a.remove(f),o.remove(f)}))return this.isLoading||(this.isLoading=!0,this.dispatchEvent({type:"tiles-load-start"})),r.setMemoryUsage(e,this.getBytesUsed(e)),this.cachedSinceLoadComplete.add(e),i.inCacheSinceLoad++,i.inCache++,i.downloading++,e.__loadingState=_e,o.add(e,f=>{if(h.aborted)return Promise.resolve();const p=this.invokeOnePlugin(g=>g.fetchData&&g.fetchData(n,{...this.fetchOptions,signal:h}));return this.dispatchEvent({type:"tile-download-start",tile:e}),p}).then(f=>{if(!h.aborted)if(f instanceof Response){if(f.ok)return l==="json"?f.json():f.arrayBuffer();throw new Error(`Failed to load model with error code ${f.status}`)}else return f}).then(f=>{if(!h.aborted)return i.downloading--,i.parsing++,e.__loadingState=ke,a.add(e,p=>h.aborted?Promise.resolve():l==="json"&&f.root?(this.preprocessTileSet(f,n,e),e.children.push(f.root),s=f,t=!0,Promise.resolve()):this.invokeOnePlugin(g=>g.parseTile&&g.parseTile(f,p,l,n,h)))}).then(()=>{if(!h.aborted){if(i.parsing--,e.__loadingState=me,r.setLoaded(e,!0),r.getMemoryUsage(e)===0){const f=this.getBytesUsed(e);if(r.isFull()&&f>0){r.remove(e);return}else r.setMemoryUsage(e,f)}this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),t&&this.dispatchEvent({type:"load-tile-set",tileSet:s,url:n}),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e})}}).catch(f=>{h.aborted||(f.name!=="AbortError"?(a.remove(e),o.remove(e),e.__loadingState===ke?i.parsing--:e.__loadingState===_e&&i.downloading--,i.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(f),e.__loadingState=se,r.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:f,url:n})):r.remove(e))})}getAttributions(e=[]){return this.invokeAllPlugins(t=>t!==this&&t.getAttributions&&t.getAttributions(e)),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s.length===0?null:Promise.all(s)}}class Fe{constructor(){this.fetchOptions={},this.workingPath=""}load(...e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(...e)}loadAsync(e){return fetch(e,this.fetchOptions).then(t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()}).then(t=>(this.workingPath===""&&(this.workingPath=this.workingPathForURL(e)),this.parse(t)))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}const bn=new TextDecoder;function ps(c){return bn.decode(c)}function ms(c,e,t,s,n,i){let r;switch(s){case"SCALAR":r=1;break;case"VEC2":r=2;break;case"VEC3":r=3;break;case"VEC4":r=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${i}".`)}let o;const a=t*r;switch(n){case"BYTE":o=new Int8Array(c,e,a);break;case"UNSIGNED_BYTE":o=new Uint8Array(c,e,a);break;case"SHORT":o=new Int16Array(c,e,a);break;case"UNSIGNED_SHORT":o=new Uint16Array(c,e,a);break;case"INT":o=new Int32Array(c,e,a);break;case"UNSIGNED_INT":o=new Uint32Array(c,e,a);break;case"FLOAT":o=new Float32Array(c,e,a);break;case"DOUBLE":o=new Float64Array(c,e,a);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${i}".`)}return o}class Oe{constructor(e,t,s,n){this.buffer=e,this.binOffset=t+s,this.binLength=n;let i=null;if(s!==0){const r=new Uint8Array(e,t,s);i=JSON.parse(ps(r))}else i={};this.header=i}getKeys(){return Object.keys(this.header)}getData(e,t,s=null,n=null){const i=this.header;if(!(e in i))return null;const r=i[e];if(r instanceof Object){if(Array.isArray(r))return r;{const{buffer:o,binOffset:a,binLength:l}=this,u=r.byteOffset||0,h=r.type||n,d=r.componentType||s;if("type"in r&&n&&r.type!==n)throw new Error("FeatureTable: Specified type does not match expected type.");const f=a+u,p=ms(o,f,t,h,d,e);if(f+p.byteLength>a+l)throw new Error("FeatureTable: Feature data read outside binary body length.");return p}}else return r}getBuffer(e,t){const{buffer:s,binOffset:n}=this;return s.slice(n+e,n+e+t)}}class xn{constructor(e){this.batchTable=e;const t=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=t.classes;for(const n of this.classes){const i=n.instances;for(const r in i)n.instances[r]=this._parseProperty(i[r],n.length,r)}if(this.instancesLength=t.instancesLength,this.classIds=this._parseProperty(t.classIds,this.instancesLength,"classIds"),t.parentCounts?this.parentCounts=this._parseProperty(t.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),t.parentIds){const n=this.parentCounts.reduce((i,r)=>i+r,0);this.parentIds=this._parseProperty(t.parentIds,n,"parentIds")}else this.parentIds=null;this.instancesIds=[];const s={};for(const n of this.classIds)s[n]=s[n]??0,this.instancesIds.push(s[n]),s[n]++}_parseProperty(e,t,s){if(Array.isArray(e))return e;{const{buffer:n,binOffset:i}=this.batchTable,r=e.byteOffset,o=e.componentType||"UNSIGNED_SHORT",a=i+r;return ms(n,a,t,"SCALAR",o,s)}}getDataFromId(e,t={}){const s=this.parentCounts[e];if(this.parentIds&&s>0){let a=0;for(let l=0;l<e;l++)a+=this.parentCounts[l];for(let l=0;l<s;l++){const u=this.parentIds[a+l];u!==e&&this.getDataFromId(u,t)}}const n=this.classIds[e],i=this.classes[n].instances,r=this.classes[n].name,o=this.instancesIds[e];for(const a in i)t[r]=t[r]||{},t[r][a]=i[a][o];return t}}class ut extends Oe{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,s,n,i){super(e,s,n,i),this.count=t,this.extensions={};const r=this.header.extensions;r&&r["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new xn(this))}getData(e,t=null,s=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,s)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error(`BatchTable: id value "${e}" out of bounds for "${this.count}" features number.`);for(const s of this.getKeys())s!=="extensions"&&(t[s]=super.getData(s,this.count)[e]);for(const s in this.extensions){const n=this.extensions[s];n.getDataFromId instanceof Function&&(t[s]=t[s]||{},n.getDataFromId(e,t[s]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}function ie(c){if(c===null||c.byteLength<4)return"";let e;if(c instanceof DataView?e=c:e=new DataView(c),String.fromCharCode(e.getUint8(0))==="{")return null;let t="";for(let s=0;s<4;s++)t+=String.fromCharCode(e.getUint8(s));return t}class wn extends Fe{parse(e){const t=new DataView(e),s=ie(t);console.assert(s==="b3dm");const n=t.getUint32(4,!0);console.assert(n===1);const i=t.getUint32(8,!0);console.assert(i===e.byteLength);const r=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),u=28,h=e.slice(u,u+r+o),d=new Oe(h,0,r,o),f=u+r+o,p=e.slice(f,f+a+l),g=new ut(p,d.getData("BATCH_LENGTH"),0,a,l),m=f+a+l,_=new Uint8Array(e,m,i-m);return{version:n,featureTable:d,batchTable:g,glbBytes:_}}}class En extends Fe{parse(e){const t=new DataView(e),s=ie(t);console.assert(s==="i3dm");const n=t.getUint32(4,!0);console.assert(n===1);const i=t.getUint32(8,!0);console.assert(i===e.byteLength);const r=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),u=t.getUint32(28,!0),h=32,d=e.slice(h,h+r+o),f=new Oe(d,0,r,o),p=h+r+o,g=e.slice(p,p+a+l),m=new ut(g,f.getData("INSTANCES_LENGTH"),0,a,l),_=p+a+l,y=new Uint8Array(e,_,i-_);let R=null,b=null,T=null;if(u)R=y,b=Promise.resolve();else{const w=this.resolveExternalURL(ps(y)),E=w.split(/[\\/]/g);E.pop(),T=E.join("/"),b=fetch(w,this.fetchOptions).then(x=>{if(!x.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${w}" with status ${x.status} : ${x.statusText}`);return x.arrayBuffer()}).then(x=>{R=new Uint8Array(x)})}return b.then(()=>({version:n,featureTable:f,batchTable:m,glbBytes:R,gltfWorkingPath:T}))}}class Sn extends Fe{parse(e){const t=new DataView(e),s=ie(t);console.assert(s==="pnts");const n=t.getUint32(4,!0);console.assert(n===1);const i=t.getUint32(8,!0);console.assert(i===e.byteLength);const r=t.getUint32(12,!0),o=t.getUint32(16,!0),a=t.getUint32(20,!0),l=t.getUint32(24,!0),u=28,h=e.slice(u,u+r+o),d=new Oe(h,0,r,o),f=u+r+o,p=e.slice(f,f+a+l),g=new ut(p,d.getData("BATCH_LENGTH")||d.getData("POINTS_LENGTH"),0,a,l);return Promise.resolve({version:n,featureTable:d,batchTable:g})}}class Rn extends Fe{parse(e){const t=new DataView(e),s=ie(t);console.assert(s==="cmpt",'CMPTLoader: The magic bytes equal "cmpt".');const n=t.getUint32(4,!0);console.assert(n===1,'CMPTLoader: The version listed in the header is "1".');const i=t.getUint32(8,!0);console.assert(i===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const r=t.getUint32(12,!0),o=[];let a=16;for(let l=0;l<r;l++){const u=new DataView(e,a,12),h=ie(u),d=u.getUint32(4,!0),f=u.getUint32(8,!0),p=new Uint8Array(e,a,f);o.push({type:h,buffer:p,version:d}),a+=f}return{version:n,tiles:o}}}function Ln(c){let e=0;for(const s in c.attributes){const n=c.getAttribute(s);e+=n.count*n.itemSize*n.array.BYTES_PER_ELEMENT}const t=c.getIndex();return e+=t?t.count*t.itemSize*t.array.BYTES_PER_ELEMENT:0,e}function xt(c,e){if(e===Ps)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),c;if(e===tt||e===Wt){let t=c.getIndex();if(t===null){const r=[],o=c.getAttribute("position");if(o!==void 0){for(let a=0;a<o.count;a++)r.push(a);c.setIndex(r),t=c.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),c}const s=t.count-2,n=[];if(e===tt)for(let r=1;r<=s;r++)n.push(t.getX(0)),n.push(t.getX(r)),n.push(t.getX(r+1));else for(let r=0;r<s;r++)r%2===0?(n.push(t.getX(r)),n.push(t.getX(r+1)),n.push(t.getX(r+2))):(n.push(t.getX(r+2)),n.push(t.getX(r+1)),n.push(t.getX(r)));n.length/3!==s&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=c.clone();return i.setIndex(n),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),c}class ht extends Is{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Nn(t)}),this.register(function(t){return new Fn(t)}),this.register(function(t){return new Gn(t)}),this.register(function(t){return new jn(t)}),this.register(function(t){return new zn(t)}),this.register(function(t){return new vn(t)}),this.register(function(t){return new Un(t)}),this.register(function(t){return new Dn(t)}),this.register(function(t){return new Bn(t)}),this.register(function(t){return new In(t)}),this.register(function(t){return new kn(t)}),this.register(function(t){return new On(t)}),this.register(function(t){return new Hn(t)}),this.register(function(t){return new Vn(t)}),this.register(function(t){return new Cn(t)}),this.register(function(t){return new Kn(t)}),this.register(function(t){return new qn(t)})}load(e,t,s,n){const i=this;let r;if(this.resourcePath!=="")r=this.resourcePath;else if(this.path!==""){const l=fe.extractUrlBase(e);r=fe.resolveURL(l,this.path)}else r=fe.extractUrlBase(e);this.manager.itemStart(e);const o=function(l){n?n(l):console.error(l),i.manager.itemError(e),i.manager.itemEnd(e)},a=new Xt(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(l){try{i.parse(l,r,function(u){t(u),i.manager.itemEnd(e)},o)}catch(u){o(u)}},s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,n){let i;const r={},o={},a=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===gs){try{r[M.KHR_BINARY_GLTF]=new Wn(e)}catch(h){n&&n(h);return}i=JSON.parse(r[M.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const l=new or(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const h=this.pluginCallbacks[u](l);h.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[h.name]=h,r[h.name]=!0}if(i.extensionsUsed)for(let u=0;u<i.extensionsUsed.length;++u){const h=i.extensionsUsed[u],d=i.extensionsRequired||[];switch(h){case M.KHR_MATERIALS_UNLIT:r[h]=new Pn;break;case M.KHR_DRACO_MESH_COMPRESSION:r[h]=new Xn(i,this.dracoLoader);break;case M.KHR_TEXTURE_TRANSFORM:r[h]=new Qn;break;case M.KHR_MESH_QUANTIZATION:r[h]=new Yn;break;default:d.indexOf(h)>=0&&o[h]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+h+'".')}}l.setExtensions(r),l.setPlugins(o),l.parse(s,n)}parseAsync(e,t){const s=this;return new Promise(function(n,i){s.parse(e,t,n,i)})}}function Mn(){let c={};return{get:function(e){return c[e]},add:function(e,t){c[e]=t},remove:function(e){delete c[e]},removeAll:function(){c={}}}}const M={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Cn{constructor(e){this.parser=e,this.name=M.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let n=t.cache.get(s);if(n)return n;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let l;const u=new $(16777215);a.color!==void 0&&u.setRGB(a.color[0],a.color[1],a.color[2],z);const h=a.range!==void 0?a.range:0;switch(a.type){case"directional":l=new Os(u),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new Fs(u),l.distance=h;break;case"spot":l=new Ns(u),l.distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,l.angle=a.spot.outerConeAngle,l.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return l.position.set(0,0,0),l.decay=2,j(l,a),a.intensity!==void 0&&(l.intensity=a.intensity),l.name=t.createUniqueName(a.name||"light_"+e),n=Promise.resolve(l),t.cache.add(s,n),n}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],o=(i.extensions&&i.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(a){return s._getNodeRef(t.cache,o,a)})}}class Pn{constructor(){this.name=M.KHR_MATERIALS_UNLIT}getMaterialType(){return he}extendParams(e,t,s){const n=[];e.color=new $(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const r=i.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],z),e.opacity=r[3]}i.baseColorTexture!==void 0&&n.push(s.assignTexture(e,"map",i.baseColorTexture,pe))}return Promise.all(n)}}class In{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class Nn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];if(r.clearcoatFactor!==void 0&&(t.clearcoat=r.clearcoatFactor),r.clearcoatTexture!==void 0&&i.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),r.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),r.clearcoatRoughnessTexture!==void 0&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),r.clearcoatNormalTexture!==void 0&&(i.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),r.clearcoatNormalTexture.scale!==void 0)){const o=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new ge(o,o)}return Promise.all(i)}}class Fn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_DISPERSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.dispersion=i.dispersion!==void 0?i.dispersion:0,Promise.resolve()}}class On{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return r.iridescenceFactor!==void 0&&(t.iridescence=r.iridescenceFactor),r.iridescenceTexture!==void 0&&i.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),r.iridescenceIor!==void 0&&(t.iridescenceIOR=r.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),r.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),r.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),r.iridescenceThicknessTexture!==void 0&&i.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(i)}}class vn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new $(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=n.extensions[this.name];if(r.sheenColorFactor!==void 0){const o=r.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],z)}return r.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=r.sheenRoughnessFactor),r.sheenColorTexture!==void 0&&i.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,pe)),r.sheenRoughnessTexture!==void 0&&i.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(i)}}class Un{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return r.transmissionFactor!==void 0&&(t.transmission=r.transmissionFactor),r.transmissionTexture!==void 0&&i.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(i)}}class Dn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.thickness=r.thicknessFactor!==void 0?r.thicknessFactor:0,r.thicknessTexture!==void 0&&i.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const o=r.attenuationColor||[1,1,1];return t.attenuationColor=new $().setRGB(o[0],o[1],o[2],z),Promise.all(i)}}class Bn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class kn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];t.specularIntensity=r.specularFactor!==void 0?r.specularFactor:1,r.specularTexture!==void 0&&i.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const o=r.specularColorFactor||[1,1,1];return t.specularColor=new $().setRGB(o[0],o[1],o[2],z),r.specularColorTexture!==void 0&&i.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,pe)),Promise.all(i)}}class Vn{constructor(e){this.parser=e,this.name=M.EXT_MATERIALS_BUMP}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return t.bumpScale=r.bumpFactor!==void 0?r.bumpFactor:1,r.bumpTexture!==void 0&&i.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(i)}}class Hn{constructor(e){this.parser=e,this.name=M.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return!s.extensions||!s.extensions[this.name]?null:B}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return r.anisotropyStrength!==void 0&&(t.anisotropy=r.anisotropyStrength),r.anisotropyRotation!==void 0&&(t.anisotropyRotation=r.anisotropyRotation),r.anisotropyTexture!==void 0&&i.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(i)}}class Gn{constructor(e){this.parser=e,this.name=M.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,r)}}class jn{constructor(e){this.parser=e,this.name=M.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],o=n.images[r.source];let a=s.textureLoader;if(o.uri){const l=s.options.manager.getHandler(o.uri);l!==null&&(a=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,r.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class zn{constructor(e){this.parser=e,this.name=M.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],o=n.images[r.source];let a=s.textureLoader;if(o.uri){const l=s.options.manager.getHandler(o.uri);l!==null&&(a=l)}return this.detectSupport().then(function(l){if(l)return s.loadTextureImage(e,r.source,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Kn{constructor(e){this.name=M.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const n=s.extensions[this.name],i=this.parser.getDependency("buffer",n.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(o){const a=n.byteOffset||0,l=n.byteLength||0,u=n.count,h=n.byteStride,d=new Uint8Array(o,a,l);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(u,h,d,n.mode,n.filter).then(function(f){return f.buffer}):r.ready.then(function(){const f=new ArrayBuffer(u*h);return r.decodeGltfBuffer(new Uint8Array(f),u,h,d,n.mode,n.filter),f})})}else return null}}class qn{constructor(e){this.name=M.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||s.mesh===void 0)return null;const n=t.meshes[s.mesh];for(const l of n.primitives)if(l.mode!==v.TRIANGLES&&l.mode!==v.TRIANGLE_STRIP&&l.mode!==v.TRIANGLE_FAN&&l.mode!==void 0)return null;const r=s.extensions[this.name].attributes,o=[],a={};for(const l in r)o.push(this.parser.getDependency("accessor",r[l]).then(u=>(a[l]=u,a[l])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(l=>{const u=l.pop(),h=u.isGroup?u.children:[u],d=l[0].count,f=[];for(const p of h){const g=new C,m=new S,_=new Ie,y=new S(1,1,1),R=new Qt(p.geometry,p.material,d);for(let b=0;b<d;b++)a.TRANSLATION&&m.fromBufferAttribute(a.TRANSLATION,b),a.ROTATION&&_.fromBufferAttribute(a.ROTATION,b),a.SCALE&&y.fromBufferAttribute(a.SCALE,b),R.setMatrixAt(b,g.compose(m,_,y));for(const b in a)if(b==="_COLOR_0"){const T=a[b];R.instanceColor=new vs(T.array,T.itemSize,T.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&p.geometry.setAttribute(b,a[b]);Yt.prototype.copy.call(R,p),this.parser.assignFinalMaterial(R),f.push(R)}return u.isGroup?(u.clear(),u.add(...f),u):f[0]}))}}const gs="glTF",oe=12,wt={JSON:1313821514,BIN:5130562};class Wn{constructor(e){this.name=M.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,oe),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==gs)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const n=this.header.length-oe,i=new DataView(e,oe);let r=0;for(;r<n;){const o=i.getUint32(r,!0);r+=4;const a=i.getUint32(r,!0);if(r+=4,a===wt.JSON){const l=new Uint8Array(e,oe+r,o);this.content=s.decode(l)}else if(a===wt.BIN){const l=oe+r;this.body=e.slice(l,l+o)}r+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Xn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=M.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,o={},a={},l={};for(const u in r){const h=rt[u]||u.toLowerCase();o[h]=r[u]}for(const u in e.attributes){const h=rt[u]||u.toLowerCase();if(r[u]!==void 0){const d=s.accessors[e.attributes[u]],f=re[d.componentType];l[h]=f.name,a[h]=d.normalized===!0}}return t.getDependency("bufferView",i).then(function(u){return new Promise(function(h,d){n.decodeDracoFile(u,function(f){for(const p in f.attributes){const g=f.attributes[p],m=a[p];m!==void 0&&(g.normalized=m)}h(f)},o,l,z,d)})})}}class Qn{constructor(){this.name=M.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Yn{constructor(){this.name=M.KHR_MESH_QUANTIZATION}}class Ts extends cn{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let r=0;r!==n;r++)t[r]=s[i+r];return t}interpolate_(e,t,s,n){const i=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=o*2,l=o*3,u=n-t,h=(s-t)/u,d=h*h,f=d*h,p=e*l,g=p-l,m=-2*f+3*d,_=f-d,y=1-m,R=_-d+h;for(let b=0;b!==o;b++){const T=r[g+b+o],w=r[g+b+a]*u,E=r[p+b+o],x=r[p+b]*u;i[b]=y*T+R*w+m*E+_*x}return i}}const $n=new Ie;class Jn extends Ts{interpolate_(e,t,s,n){const i=super.interpolate_(e,t,s,n);return $n.fromArray(i).normalize().toArray(i),i}}const v={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},re={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Et={9728:Gs,9729:Jt,9984:Hs,9985:Vs,9986:ks,9987:$t},St={33071:zs,33648:js,10497:st},He={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},rt={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},K={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Zn={CUBICSPLINE:void 0,LINEAR:ns,STEP:rn},Ge={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function er(c){return c.DefaultMaterial===void 0&&(c.DefaultMaterial=new es({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:an})),c.DefaultMaterial}function J(c,e,t){for(const s in t.extensions)c[s]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=t.extensions[s])}function j(c,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(c.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function tr(c,e,t){let s=!1,n=!1,i=!1;for(let l=0,u=e.length;l<u;l++){const h=e[l];if(h.POSITION!==void 0&&(s=!0),h.NORMAL!==void 0&&(n=!0),h.COLOR_0!==void 0&&(i=!0),s&&n&&i)break}if(!s&&!n&&!i)return Promise.resolve(c);const r=[],o=[],a=[];for(let l=0,u=e.length;l<u;l++){const h=e[l];if(s){const d=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):c.attributes.position;r.push(d)}if(n){const d=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):c.attributes.normal;o.push(d)}if(i){const d=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):c.attributes.color;a.push(d)}}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(a)]).then(function(l){const u=l[0],h=l[1],d=l[2];return s&&(c.morphAttributes.position=u),n&&(c.morphAttributes.normal=h),i&&(c.morphAttributes.color=d),c.morphTargetsRelative=!0,c})}function sr(c,e){if(c.updateMorphTargets(),e.weights!==void 0)for(let t=0,s=e.weights.length;t<s;t++)c.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(c.morphTargetInfluences.length===t.length){c.morphTargetDictionary={};for(let s=0,n=t.length;s<n;s++)c.morphTargetDictionary[t[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function nr(c){let e;const t=c.extensions&&c.extensions[M.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+je(t.attributes):e=c.indices+":"+je(c.attributes)+":"+c.mode,c.targets!==void 0)for(let s=0,n=c.targets.length;s<n;s++)e+=":"+je(c.targets[s]);return e}function je(c){let e="";const t=Object.keys(c).sort();for(let s=0,n=t.length;s<n;s++)e+=t[s]+":"+c[t[s]]+";";return e}function it(c){switch(c){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function rr(c){return c.search(/\.jpe?g($|\?)/i)>0||c.search(/^data\:image\/jpeg/)===0?"image/jpeg":c.search(/\.webp($|\?)/i)>0||c.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const ir=new C;class or{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Mn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=-1,i=!1,r=-1;if(typeof navigator<"u"){const o=navigator.userAgent;s=/^((?!chrome|android).)*safari/i.test(o)===!0;const a=o.match(/Version\/(\d+)/);n=s&&a?parseInt(a[1],10):-1,i=o.indexOf("Firefox")>-1,r=i?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||s&&n<17||i&&r<98?this.textureLoader=new Us(this.options.manager):this.textureLoader=new Ds(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Xt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(r){return r._markDefs&&r._markDefs()}),Promise.all(this._invokeAll(function(r){return r.beforeRoot&&r.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(r){const o={scene:r[0][n.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:n.asset,parser:s,userData:{}};return J(i,o,n),j(o,n),Promise.all(s._invokeAll(function(a){return a.afterRoot&&a.afterRoot(o)})).then(function(){for(const a of o.scenes)a.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const r=t[n].joints;for(let o=0,a=r.length;o<a;o++)e[r[o]].isBone=!0}for(let n=0,i=e.length;n<i;n++){const r=e[n];r.mesh!==void 0&&(this._addNodeRef(this.meshCache,r.mesh),r.skin!==void 0&&(s[r.mesh].isSkinnedMesh=!0)),r.camera!==void 0&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone(),i=(r,o)=>{const a=this.associations.get(r);a!=null&&this.associations.set(o,a);for(const[l,u]of r.children.entries())i(u,o.children[l])};return i(s,n),n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":n=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":n=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":n=this.loadSkin(t);break;case"animation":n=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":n=this.loadCamera(t);break;default:if(n=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!n)throw new Error("Unknown type: "+e);break}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(n.map(function(i,r){return s.getDependency(e,r)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[M.KHR_BINARY_GLTF].body);const n=this.options;return new Promise(function(i,r){s.load(fe.resolveURL(t.uri,n.path),i,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(s){const n=t.byteLength||0,i=t.byteOffset||0;return s.slice(i,i+n)})}loadAccessor(e){const t=this,s=this.json,n=this.json.accessors[e];if(n.bufferView===void 0&&n.sparse===void 0){const r=He[n.type],o=re[n.componentType],a=n.normalized===!0,l=new o(n.count*r);return Promise.resolve(new D(l,r,a))}const i=[];return n.bufferView!==void 0?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),n.sparse!==void 0&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then(function(r){const o=r[0],a=He[n.type],l=re[n.componentType],u=l.BYTES_PER_ELEMENT,h=u*a,d=n.byteOffset||0,f=n.bufferView!==void 0?s.bufferViews[n.bufferView].byteStride:void 0,p=n.normalized===!0;let g,m;if(f&&f!==h){const _=Math.floor(d/f),y="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+_+":"+n.count;let R=t.cache.get(y);R||(g=new l(o,_*f,n.count*f/u),R=new Bs(g,f/u),t.cache.add(y,R)),m=new on(R,a,d%f/u,p)}else o===null?g=new l(n.count*a):g=new l(o,d,n.count*a),m=new D(g,a,p);if(n.sparse!==void 0){const _=He.SCALAR,y=re[n.sparse.indices.componentType],R=n.sparse.indices.byteOffset||0,b=n.sparse.values.byteOffset||0,T=new y(r[1],R,n.sparse.count*_),w=new l(r[2],b,n.sparse.count*a);o!==null&&(m=new D(m.array.slice(),m.itemSize,m.normalized));for(let E=0,x=T.length;E<x;E++){const A=T[E];if(m.setX(A,w[E*a]),a>=2&&m.setY(A,w[E*a+1]),a>=3&&m.setZ(A,w[E*a+2]),a>=4&&m.setW(A,w[E*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m})}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,r=t.images[i];let o=this.textureLoader;if(r.uri){const a=s.manager.getHandler(r.uri);a!==null&&(o=a)}return this.loadTextureImage(e,i,o)}loadTextureImage(e,t,s){const n=this,i=this.json,r=i.textures[e],o=i.images[t],a=(o.uri||o.bufferView)+":"+r.sampler;if(this.textureCache[a])return this.textureCache[a];const l=this.loadImageSource(t,s).then(function(u){u.flipY=!1,u.name=r.name||o.name||"",u.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(u.name=o.uri);const d=(i.samplers||{})[r.sampler]||{};return u.magFilter=Et[d.magFilter]||Jt,u.minFilter=Et[d.minFilter]||$t,u.wrapS=St[d.wrapS]||st,u.wrapT=St[d.wrapT]||st,n.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[a]=l,l}loadImageSource(e,t){const s=this,n=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const r=n.images[e],o=self.URL||self.webkitURL;let a=r.uri||"",l=!1;if(r.bufferView!==void 0)a=s.getDependency("bufferView",r.bufferView).then(function(h){l=!0;const d=new Blob([h],{type:r.mimeType});return a=o.createObjectURL(d),a});else if(r.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(a).then(function(h){return new Promise(function(d,f){let p=d;t.isImageBitmapLoader===!0&&(p=function(g){const m=new ft(g);m.needsUpdate=!0,d(m)}),t.load(fe.resolveURL(h,i.path),p,void 0,f)})}).then(function(h){return l===!0&&o.revokeObjectURL(a),j(h,r),h.userData.mimeType=r.mimeType||rr(r.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),h});return this.sourceCache[e]=u,u}assignTexture(e,t,s,n){const i=this;return this.getDependency("texture",s.index).then(function(r){if(!r)return null;if(s.texCoord!==void 0&&s.texCoord>0&&(r=r.clone(),r.channel=s.texCoord),i.extensions[M.KHR_TEXTURE_TRANSFORM]){const o=s.extensions!==void 0?s.extensions[M.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const a=i.associations.get(r);r=i.extensions[M.KHR_TEXTURE_TRANSFORM].extendTexture(r,o),i.associations.set(r,a)}}return n!==void 0&&(r.colorSpace=n),e[t]=r,r})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const n=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,r=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+s.uuid;let a=this.cache.get(o);a||(a=new Zt,De.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,a.sizeAttenuation=!1,this.cache.add(o,a)),s=a}else if(e.isLine){const o="LineBasicMaterial:"+s.uuid;let a=this.cache.get(o);a||(a=new Ks,De.prototype.copy.call(a,s),a.color.copy(s.color),a.map=s.map,this.cache.add(o,a)),s=a}if(n||i||r){let o="ClonedMaterial:"+s.uuid+":";n&&(o+="derivative-tangents:"),i&&(o+="vertex-colors:"),r&&(o+="flat-shading:");let a=this.cache.get(o);a||(a=s.clone(),i&&(a.vertexColors=!0),r&&(a.flatShading=!0),n&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(o,a),this.associations.set(a,this.associations.get(s))),s=a}e.material=s}getMaterialType(){return es}loadMaterial(e){const t=this,s=this.json,n=this.extensions,i=s.materials[e];let r;const o={},a=i.extensions||{},l=[];if(a[M.KHR_MATERIALS_UNLIT]){const h=n[M.KHR_MATERIALS_UNLIT];r=h.getMaterialType(),l.push(h.extendParams(o,i,t))}else{const h=i.pbrMetallicRoughness||{};if(o.color=new $(1,1,1),o.opacity=1,Array.isArray(h.baseColorFactor)){const d=h.baseColorFactor;o.color.setRGB(d[0],d[1],d[2],z),o.opacity=d[3]}h.baseColorTexture!==void 0&&l.push(t.assignTexture(o,"map",h.baseColorTexture,pe)),o.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,o.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(o,"metalnessMap",h.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",h.metallicRoughnessTexture))),r=this._invokeOne(function(d){return d.getMaterialType&&d.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(d){return d.extendMaterialParams&&d.extendMaterialParams(e,o)})))}i.doubleSided===!0&&(o.side=qs);const u=i.alphaMode||Ge.OPAQUE;if(u===Ge.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,u===Ge.MASK&&(o.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&r!==he&&(l.push(t.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new ge(1,1),i.normalTexture.scale!==void 0)){const h=i.normalTexture.scale;o.normalScale.set(h,h)}if(i.occlusionTexture!==void 0&&r!==he&&(l.push(t.assignTexture(o,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&r!==he){const h=i.emissiveFactor;o.emissive=new $().setRGB(h[0],h[1],h[2],z)}return i.emissiveTexture!==void 0&&r!==he&&l.push(t.assignTexture(o,"emissiveMap",i.emissiveTexture,pe)),Promise.all(l).then(function(){const h=new r(o);return i.name&&(h.name=i.name),j(h,i),t.associations.set(h,{materials:e}),i.extensions&&J(n,h,i),h})}createUniqueName(e){const t=Ws.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,n=this.primitiveCache;function i(o){return s[M.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(a){return Rt(a,o,t)})}const r=[];for(let o=0,a=e.length;o<a;o++){const l=e[o],u=nr(l),h=n[u];if(h)r.push(h.promise);else{let d;l.extensions&&l.extensions[M.KHR_DRACO_MESH_COMPRESSION]?d=i(l):d=Rt(new ts,l,t),n[u]={primitive:l,promise:d},r.push(d)}}return Promise.all(r)}loadMesh(e){const t=this,s=this.json,n=this.extensions,i=s.meshes[e],r=i.primitives,o=[];for(let a=0,l=r.length;a<l;a++){const u=r[a].material===void 0?er(this.cache):this.getDependency("material",r[a].material);o.push(u)}return o.push(t.loadGeometries(r)),Promise.all(o).then(function(a){const l=a.slice(0,a.length-1),u=a[a.length-1],h=[];for(let f=0,p=u.length;f<p;f++){const g=u[f],m=r[f];let _;const y=l[f];if(m.mode===v.TRIANGLES||m.mode===v.TRIANGLE_STRIP||m.mode===v.TRIANGLE_FAN||m.mode===void 0)_=i.isSkinnedMesh===!0?new Xs(g,y):new Qs(g,y),_.isSkinnedMesh===!0&&_.normalizeSkinWeights(),m.mode===v.TRIANGLE_STRIP?_.geometry=xt(_.geometry,Wt):m.mode===v.TRIANGLE_FAN&&(_.geometry=xt(_.geometry,tt));else if(m.mode===v.LINES)_=new Ys(g,y);else if(m.mode===v.LINE_STRIP)_=new $s(g,y);else if(m.mode===v.LINE_LOOP)_=new Js(g,y);else if(m.mode===v.POINTS)_=new ss(g,y);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(_.geometry.morphAttributes).length>0&&sr(_,i),_.name=t.createUniqueName(i.name||"mesh_"+e),j(_,i),m.extensions&&J(n,_,m),t.assignFinalMaterial(_),h.push(_)}for(let f=0,p=h.length;f<p;f++)t.associations.set(h[f],{meshes:e,primitives:f});if(h.length===1)return i.extensions&&J(n,h[0],i),h[0];const d=new ne;i.extensions&&J(n,d,i),t.associations.set(d,{meshes:e});for(let f=0,p=h.length;f<p;f++)d.add(h[f]);return d})}loadCamera(e){let t;const s=this.json.cameras[e],n=s[s.type];if(!n){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return s.type==="perspective"?t=new Zs(Q.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):s.type==="orthographic"&&(t=new en(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),j(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s=[];for(let n=0,i=t.joints.length;n<i;n++)s.push(this._loadNodeShallow(t.joints[n]));return t.inverseBindMatrices!==void 0?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(n){const i=n.pop(),r=n,o=[],a=[];for(let l=0,u=r.length;l<u;l++){const h=r[l];if(h){o.push(h);const d=new C;i!==null&&d.fromArray(i.array,l*16),a.push(d)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new tn(o,a)})}loadAnimation(e){const t=this.json,s=this,n=t.animations[e],i=n.name?n.name:"animation_"+e,r=[],o=[],a=[],l=[],u=[];for(let h=0,d=n.channels.length;h<d;h++){const f=n.channels[h],p=n.samplers[f.sampler],g=f.target,m=g.node,_=n.parameters!==void 0?n.parameters[p.input]:p.input,y=n.parameters!==void 0?n.parameters[p.output]:p.output;g.node!==void 0&&(r.push(this.getDependency("node",m)),o.push(this.getDependency("accessor",_)),a.push(this.getDependency("accessor",y)),l.push(p),u.push(g))}return Promise.all([Promise.all(r),Promise.all(o),Promise.all(a),Promise.all(l),Promise.all(u)]).then(function(h){const d=h[0],f=h[1],p=h[2],g=h[3],m=h[4],_=[];for(let y=0,R=d.length;y<R;y++){const b=d[y],T=f[y],w=p[y],E=g[y],x=m[y];if(b===void 0)continue;b.updateMatrix&&b.updateMatrix();const A=s._createAnimationTracks(b,T,w,E,x);if(A)for(let L=0;L<A.length;L++)_.push(A[L])}return new sn(i,void 0,_)})}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return n.mesh===void 0?null:s.getDependency("mesh",n.mesh).then(function(i){const r=s._getNodeRef(s.meshCache,n.mesh,i);return n.weights!==void 0&&r.traverse(function(o){if(o.isMesh)for(let a=0,l=n.weights.length;a<l;a++)o.morphTargetInfluences[a]=n.weights[a]}),r})}loadNode(e){const t=this.json,s=this,n=t.nodes[e],i=s._loadNodeShallow(e),r=[],o=n.children||[];for(let l=0,u=o.length;l<u;l++)r.push(s.getDependency("node",o[l]));const a=n.skin===void 0?Promise.resolve(null):s.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),a]).then(function(l){const u=l[0],h=l[1],d=l[2];d!==null&&u.traverse(function(f){f.isSkinnedMesh&&f.bind(d,ir)});for(let f=0,p=h.length;f<p;f++)u.add(h[f]);return u})}_loadNodeShallow(e){const t=this.json,s=this.extensions,n=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],r=i.name?n.createUniqueName(i.name):"",o=[],a=n._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return a&&o.push(a),i.camera!==void 0&&o.push(n.getDependency("camera",i.camera).then(function(l){return n._getNodeRef(n.cameraCache,i.camera,l)})),n._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){o.push(l)}),this.nodeCache[e]=Promise.all(o).then(function(l){let u;if(i.isBone===!0?u=new nn:l.length>1?u=new ne:l.length===1?u=l[0]:u=new Yt,u!==l[0])for(let h=0,d=l.length;h<d;h++)u.add(l[h]);if(i.name&&(u.userData.name=i.name,u.name=r),j(u,i),i.extensions&&J(s,u,i),i.matrix!==void 0){const h=new C;h.fromArray(i.matrix),u.applyMatrix4(h)}else i.translation!==void 0&&u.position.fromArray(i.translation),i.rotation!==void 0&&u.quaternion.fromArray(i.rotation),i.scale!==void 0&&u.scale.fromArray(i.scale);return n.associations.has(u)||n.associations.set(u,{}),n.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],n=this,i=new ne;s.name&&(i.name=n.createUniqueName(s.name)),j(i,s),s.extensions&&J(t,i,s);const r=s.nodes||[],o=[];for(let a=0,l=r.length;a<l;a++)o.push(n.getDependency("node",r[a]));return Promise.all(o).then(function(a){for(let u=0,h=a.length;u<h;u++)i.add(a[u]);const l=u=>{const h=new Map;for(const[d,f]of n.associations)(d instanceof De||d instanceof ft)&&h.set(d,f);return u.traverse(d=>{const f=n.associations.get(d);f!=null&&h.set(d,f)}),h};return n.associations=l(i),i})}_createAnimationTracks(e,t,s,n,i){const r=[],o=e.name?e.name:e.uuid,a=[];K[i.path]===K.weights?e.traverse(function(d){d.morphTargetInfluences&&a.push(d.name?d.name:d.uuid)}):a.push(o);let l;switch(K[i.path]){case K.weights:l=mt;break;case K.rotation:l=gt;break;case K.position:case K.scale:l=pt;break;default:switch(s.itemSize){case 1:l=mt;break;case 2:case 3:default:l=pt;break}break}const u=n.interpolation!==void 0?Zn[n.interpolation]:ns,h=this._getArrayFromAccessor(s);for(let d=0,f=a.length;d<f;d++){const p=new l(a[d]+"."+K[i.path],t.array,h,u);n.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),r.push(p)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const s=it(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*s;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(s){const n=this instanceof gt?Jn:Ts;return new n(this.times,this.values,this.getValueSize()/3,s)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ar(c,e,t){const s=e.attributes,n=new rs;if(s.POSITION!==void 0){const o=t.json.accessors[s.POSITION],a=o.min,l=o.max;if(a!==void 0&&l!==void 0){if(n.set(new S(a[0],a[1],a[2]),new S(l[0],l[1],l[2])),o.normalized){const u=it(re[o.componentType]);n.min.multiplyScalar(u),n.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const o=new S,a=new S;for(let l=0,u=i.length;l<u;l++){const h=i[l];if(h.POSITION!==void 0){const d=t.json.accessors[h.POSITION],f=d.min,p=d.max;if(f!==void 0&&p!==void 0){if(a.setX(Math.max(Math.abs(f[0]),Math.abs(p[0]))),a.setY(Math.max(Math.abs(f[1]),Math.abs(p[1]))),a.setZ(Math.max(Math.abs(f[2]),Math.abs(p[2]))),d.normalized){const g=it(re[d.componentType]);a.multiplyScalar(g)}o.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(o)}c.boundingBox=n;const r=new ot;n.getCenter(r.center),r.radius=n.min.distanceTo(n.max)/2,c.boundingSphere=r}function Rt(c,e,t){const s=e.attributes,n=[];function i(r,o){return t.getDependency("accessor",r).then(function(a){c.setAttribute(o,a)})}for(const r in s){const o=rt[r]||r.toLowerCase();o in c.attributes||n.push(i(s[r],o))}if(e.indices!==void 0&&!c.index){const r=t.getDependency("accessor",e.indices).then(function(o){c.setIndex(o)});n.push(r)}return Tt.workingColorSpace!==z&&"COLOR_0"in s&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Tt.workingColorSpace}" not supported.`),j(c,e),ar(c,e,t),Promise.all(n).then(function(){return e.targets!==void 0?tr(c,e.targets,t):c})}class _s extends wn{constructor(e=Ne){super(),this.manager=e,this.adjustmentTransform=new C}parse(e){const t=super.parse(e),s=t.glbBytes.slice().buffer;return new Promise((n,i)=>{const r=this.manager,o=this.fetchOptions,a=r.getHandler("path.gltf")||new ht(r);o.credentials==="include"&&o.mode==="cors"&&a.setCrossOrigin("use-credentials"),"credentials"in o&&a.setWithCredentials(o.credentials==="include"),o.headers&&a.setRequestHeader(o.headers);let l=this.workingPath;!/[\\/]$/.test(l)&&l.length&&(l+="/");const u=this.adjustmentTransform;a.parse(s,l,h=>{const{batchTable:d,featureTable:f}=t,{scene:p}=h,g=f.getData("RTC_CENTER",1,"FLOAT","VEC3");g&&(p.position.x+=g[0],p.position.y+=g[1],p.position.z+=g[2]),h.scene.updateMatrix(),h.scene.matrix.multiply(u),h.scene.matrix.decompose(h.scene.position,h.scene.quaternion,h.scene.scale),h.batchTable=d,h.featureTable=f,p.batchTable=d,p.featureTable=f,n(h)},i)})}}function cr(c){const e=c>>11,t=c>>5&63,s=c&31,n=Math.round(e/31*255),i=Math.round(t/63*255),r=Math.round(s/31*255);return[n,i,r]}const ae=new ge;function lr(c,e,t=new S){ae.set(c,e).divideScalar(256).multiplyScalar(2).subScalar(1),t.set(ae.x,ae.y,1-Math.abs(ae.x)-Math.abs(ae.y));const s=Q.clamp(-t.z,0,1);return t.x>=0?t.setX(t.x-s):t.setX(t.x+s),t.y>=0?t.setY(t.y-s):t.setY(t.y+s),t.normalize(),t}const Lt={RGB:"color",POSITION:"position"};class ys extends Sn{constructor(e=Ne){super(),this.manager=e}parse(e){return super.parse(e).then(async t=>{const{featureTable:s,batchTable:n}=t,i=new Zt,r=s.header.extensions,o=new S;let a;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:h,byteLength:d,properties:f}=r["3DTILES_draco_point_compression"],p=this.manager.getHandler("draco.drc");if(p==null)throw new Error("PNTSLoader: dracoLoader not available.");const g={};for(const y in f)if(y in Lt&&y in f){const R=Lt[y];g[R]=f[y]}const m={attributeIDs:g,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},_=s.getBuffer(h,d);a=await p.decodeGeometry(_,m),a.attributes.color&&(i.vertexColors=!0)}else{const h=s.getData("POINTS_LENGTH"),d=s.getData("POSITION",h,"FLOAT","VEC3"),f=s.getData("NORMAL",h,"FLOAT","VEC3"),p=s.getData("NORMAL",h,"UNSIGNED_BYTE","VEC2"),g=s.getData("RGB",h,"UNSIGNED_BYTE","VEC3"),m=s.getData("RGBA",h,"UNSIGNED_BYTE","VEC4"),_=s.getData("RGB565",h,"UNSIGNED_SHORT","SCALAR"),y=s.getData("CONSTANT_RGBA",h,"UNSIGNED_BYTE","VEC4"),R=s.getData("POSITION_QUANTIZED",h,"UNSIGNED_SHORT","VEC3"),b=s.getData("QUANTIZED_VOLUME_SCALE",h,"FLOAT","VEC3"),T=s.getData("QUANTIZED_VOLUME_OFFSET",h,"FLOAT","VEC3");if(a=new ts,R){const w=new Float32Array(h*3);for(let E=0;E<h;E++)for(let x=0;x<3;x++){const A=3*E+x;w[A]=R[A]/65535*b[x]}o.x=T[0],o.y=T[1],o.z=T[2],a.setAttribute("position",new D(w,3,!1))}else a.setAttribute("position",new D(d,3,!1));if(f!==null)a.setAttribute("normal",new D(f,3,!1));else if(p!==null){const w=new Float32Array(h*3),E=new S;for(let x=0;x<h;x++){const A=p[x*2],L=p[x*2+1],P=lr(A,L,E);w[x*3]=P.x,w[x*3+1]=P.y,w[x*3+2]=P.z}a.setAttribute("normal",new D(w,3,!1))}if(m!==null)a.setAttribute("color",new D(m,4,!0)),i.vertexColors=!0,i.transparent=!0,i.depthWrite=!1;else if(g!==null)a.setAttribute("color",new D(g,3,!0)),i.vertexColors=!0;else if(_!==null){const w=new Uint8Array(h*3);for(let E=0;E<h;E++){const x=cr(_[E]);for(let A=0;A<3;A++){const L=3*E+A;w[L]=x[A]}}a.setAttribute("color",new D(w,3,!0)),i.vertexColors=!0}else if(y!==null){const w=new $(y[0],y[1],y[2]);i.color=w;const E=y[3]/255;E<1&&(i.opacity=E,i.transparent=!0,i.depthWrite=!1)}}const l=new ss(a,i);l.position.copy(o),t.scene=l,t.scene.featureTable=s,t.scene.batchTable=n;const u=s.getData("RTC_CENTER",1,"FLOAT","VEC3");return u&&(t.scene.position.x+=u[0],t.scene.position.y+=u[1],t.scene.position.z+=u[2]),t})}}new is;new S;function ur(c){const{x:e,y:t,z:s}=c;c.x=s,c.y=e,c.z=t}function hr(c){return-c+Math.PI/2}const Mt=new is,q=new S,O=new S,ze=new S,W=new C,U=new C,Ct=new C,Ke=new ot,I=new os,Pt=new S,It=new S,Nt=new S,Z=new S,Ft=new at,dr=1e-12,fr=.1,Ae=0,Ot=1,be=2;class As{constructor(e=1,t=1,s=1){this.name="",this.radius=new S(e,t,s)}intersectRay(e,t){return W.makeScale(...this.radius).invert(),Ke.center.set(0,0,0),Ke.radius=1,Ft.copy(e).applyMatrix4(W),Ft.intersectSphere(Ke,t)?(W.makeScale(...this.radius),t.applyMatrix4(W),t):null}getEastNorthUpFrame(e,t,s,n){return s.isMatrix4&&(n=s,s=0,console.warn('Ellipsoid: The signature for "getEastNorthUpFrame" has changed.')),this.getEastNorthUpAxes(e,t,Pt,It,Nt),this.getCartographicToPosition(e,t,s,Z),n.makeBasis(Pt,It,Nt).setPosition(Z)}getOrientedEastNorthUpFrame(e,t,s,n,i,r,o){return this.getObjectFrame(e,t,s,n,i,r,o,Ae)}getObjectFrame(e,t,s,n,i,r,o,a=be){return this.getEastNorthUpFrame(e,t,s,W),I.set(i,r,-n,"ZXY"),o.makeRotationFromEuler(I).premultiply(W),a===Ot?(I.set(Math.PI/2,0,0,"XYZ"),U.makeRotationFromEuler(I),o.multiply(U)):a===be&&(I.set(-Math.PI/2,0,Math.PI,"XYZ"),U.makeRotationFromEuler(I),o.multiply(U)),o}getCartographicFromObjectFrame(e,t,s=be){return s===Ot?(I.set(-Math.PI/2,0,0,"XYZ"),U.makeRotationFromEuler(I).premultiply(e)):s===be?(I.set(-Math.PI/2,0,Math.PI,"XYZ"),U.makeRotationFromEuler(I).premultiply(e)):U.copy(e),Z.setFromMatrixPosition(U),this.getPositionToCartographic(Z,t),this.getEastNorthUpFrame(t.lat,t.lon,0,W).invert(),U.premultiply(W),I.setFromRotationMatrix(U,"ZXY"),t.azimuth=-I.z,t.elevation=I.x,t.roll=I.y,t}getEastNorthUpAxes(e,t,s,n,i,r=Z){this.getCartographicToPosition(e,t,0,r),this.getCartographicToNormal(e,t,i),s.set(-r.y,r.x,0).normalize(),n.crossVectors(i,s).normalize()}getAzElRollFromRotationMatrix(e,t,s,n,i=Ae){return console.warn('Ellipsoid: "getAzElRollFromRotationMatrix" is deprecated. Use "getCartographicFromObjectFrame", instead.'),this.getCartographicToPosition(e,t,0,Z),Ct.copy(s).setPosition(Z),this.getCartographicFromObjectFrame(Ct,n,i),delete n.height,delete n.lat,delete n.lon,n}getRotationMatrixFromAzElRoll(e,t,s,n,i,r,o=Ae){return console.warn('Ellipsoid: "getRotationMatrixFromAzElRoll" function has been deprecated. Use "getObjectFrame", instead.'),this.getObjectFrame(e,t,0,s,n,i,r,o),r.setPosition(0,0,0),r}getFrame(e,t,s,n,i,r,o,a=Ae){return console.warn('Ellipsoid: "getFrame" function has been deprecated. Use "getObjectFrame", instead.'),this.getObjectFrame(e,t,r,s,n,i,o,a)}getCartographicToPosition(e,t,s,n){this.getCartographicToNormal(e,t,q);const i=this.radius;O.copy(q),O.x*=i.x**2,O.y*=i.y**2,O.z*=i.z**2;const r=Math.sqrt(q.dot(O));return O.divideScalar(r),n.copy(O).addScaledVector(q,s)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,O),this.getPositionToNormal(e,q);const s=ze.subVectors(e,O);return t.lon=Math.atan2(q.y,q.x),t.lat=Math.asin(q.z),t.height=Math.sign(s.dot(e))*s.length(),t}getCartographicToNormal(e,t,s){return Mt.set(1,hr(e),t),s.setFromSpherical(Mt).normalize(),ur(s),s}getPositionToNormal(e,t){const s=this.radius;return t.copy(e),t.x/=s.x**2,t.y/=s.y**2,t.z/=s.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const s=this.radius,n=1/s.x**2,i=1/s.y**2,r=1/s.z**2,o=e.x*e.x*n,a=e.y*e.y*i,l=e.z*e.z*r,u=o+a+l,h=Math.sqrt(1/u),d=O.copy(e).multiplyScalar(h);if(u<fr)return isFinite(h)?t.copy(d):null;const f=ze.set(d.x*n*2,d.y*i*2,d.z*r*2);let p=(1-h)*e.length()/(.5*f.length()),g=0,m,_,y,R,b,T,w,E,x,A,L;do{p-=g,y=1/(1+p*n),R=1/(1+p*i),b=1/(1+p*r),T=y*y,w=R*R,E=b*b,x=T*y,A=w*R,L=E*b,m=o*T+a*w+l*E-1,_=o*x*n+a*A*i+l*L*r;const P=-2*_;g=m/P}while(Math.abs(m)>dr);return t.set(e.x*y,e.y*R,e.z*b)}calculateHorizonDistance(e,t){const s=this.calculateEffectiveRadius(e);return Math.sqrt(2*s*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,i=e*Q.DEG2RAD,r=Math.sin(i)**2;return t/Math.sqrt(1-n*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,O);const t=ze.subVectors(e,O);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return new this.constructor().copy(this)}}const ve=new As(At,At,mn);ve.name="WGS84 Earth";const vt=new S,qe=new S,We=new S,Xe=new S,Qe=new Ie,xe=new S,we=new C,Ut=new C,Dt=new S,Bt=new C,Ye=new Ie,$e={};class bs extends En{constructor(e=Ne){super(),this.manager=e,this.adjustmentTransform=new C,this.ellipsoid=ve.clone()}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then(t=>{const{featureTable:s,batchTable:n}=t,i=t.glbBytes.slice().buffer;return new Promise((r,o)=>{const a=this.fetchOptions,l=this.manager,u=l.getHandler("path.gltf")||new ht(l);a.credentials==="include"&&a.mode==="cors"&&u.setCrossOrigin("use-credentials"),"credentials"in a&&u.setWithCredentials(a.credentials==="include"),a.headers&&u.setRequestHeader(a.headers);let h=t.gltfWorkingPath??this.workingPath;/[\\/]$/.test(h)||(h+="/");const d=this.adjustmentTransform;u.parse(i,h,f=>{const p=s.getData("INSTANCES_LENGTH"),g=s.getData("POSITION",p,"FLOAT","VEC3"),m=s.getData("NORMAL_UP",p,"FLOAT","VEC3"),_=s.getData("NORMAL_RIGHT",p,"FLOAT","VEC3"),y=s.getData("SCALE_NON_UNIFORM",p,"FLOAT","VEC3"),R=s.getData("SCALE",p,"FLOAT","SCALAR"),b=s.getData("RTC_CENTER",1,"FLOAT","VEC3"),T=s.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach(A=>{A in s.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${A}" detected.`)});const w=new S;for(let A=0;A<p;A++)w.x+=g[A*3+0]/p,w.y+=g[A*3+1]/p,w.z+=g[A*3+2]/p;const E=[],x=[];f.scene.updateMatrixWorld(),f.scene.traverse(A=>{if(A.isMesh){x.push(A);const{geometry:L,material:P}=A,F=new Qt(L,P,p);F.position.copy(w),b&&(F.position.x+=b[0],F.position.y+=b[1],F.position.z+=b[2]),E.push(F)}});for(let A=0;A<p;A++){Xe.set(g[A*3+0]-w.x,g[A*3+1]-w.y,g[A*3+2]-w.z),Qe.identity(),m&&(qe.set(m[A*3+0],m[A*3+1],m[A*3+2]),We.set(_[A*3+0],_[A*3+1],_[A*3+2]),vt.crossVectors(We,qe).normalize(),we.makeBasis(We,qe,vt),Qe.setFromRotationMatrix(we)),xe.set(1,1,1),y&&xe.set(y[A*3+0],y[A*3+1],y[A*3+2]),R&&xe.multiplyScalar(R[A]);for(let L=0,P=E.length;L<P;L++){const F=E[L];Ye.copy(Qe),T&&(F.updateMatrixWorld(),Dt.copy(Xe).applyMatrix4(F.matrixWorld),this.ellipsoid.getPositionToCartographic(Dt,$e),this.ellipsoid.getEastNorthUpFrame($e.lat,$e.lon,Bt),Ye.setFromRotationMatrix(Bt)),we.compose(Xe,Ye,xe).multiply(d);const Ue=x[L];Ut.multiplyMatrices(we,Ue.matrixWorld),F.setMatrixAt(A,Ut)}}f.scene.clear(),f.scene.add(...E),f.batchTable=n,f.featureTable=s,f.scene.batchTable=n,f.scene.featureTable=s,r(f)},o)})})}}class pr extends Rn{constructor(e=Ne){super(),this.manager=e,this.adjustmentTransform=new C,this.ellipsoid=ve.clone()}parse(e){const t=super.parse(e),{manager:s,ellipsoid:n,adjustmentTransform:i}=this,r=[];for(const o in t.tiles){const{type:a,buffer:l}=t.tiles[o];switch(a){case"b3dm":{const u=l.slice(),h=new _s(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.adjustmentTransform.copy(i);const d=h.parse(u.buffer);r.push(d);break}case"pnts":{const u=l.slice(),h=new ys(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions;const d=h.parse(u.buffer);r.push(d);break}case"i3dm":{const u=l.slice(),h=new bs(s);h.workingPath=this.workingPath,h.fetchOptions=this.fetchOptions,h.ellipsoid.copy(n),h.adjustmentTransform.copy(i);const d=h.parse(u.buffer);r.push(d);break}}}return Promise.all(r).then(o=>{const a=new ne;return o.forEach(l=>{a.add(l.scene)}),{tiles:o,scene:a}})}}const ce=new C;class mr extends ne{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new C}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?ce.copy(this.matrix):ce.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=ce.elements,s=this.matrixWorld.elements;let n=!1;for(let i=0;i<16;i++){const r=t[i],o=s[i];if(Math.abs(r-o)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(ce),this.matrixWorldInverse.copy(ce).invert();const i=this.children;for(let r=0,o=i.length;r<o;r++)i[r].updateMatrixWorld()}}}updateWorldMatrix(e,t){this.parent&&e&&this.parent.updateWorldMatrix(e,!1),this.updateMatrixWorld(!0)}}const xs=new at,Je=new S,Ee=[];function ws(c,e){return c.distance-e.distance}function Es(c,e,t,s){const{scene:n}=c.cached;t.invokeOnePlugin(r=>r.raycastTile&&r.raycastTile(c,n,e,s))||e.intersectObject(n,!0,s)}function gr(c,e,t){Es(c,e,t,Ee),Ee.sort(ws);const s=Ee[0]||null;return Ee.length=0,s}function Ss(c){return"__used"in c}function Rs(c,e,t,s=null){const{group:n,activeTiles:i}=c;s===null&&(s=xs,s.copy(t.ray).applyMatrix4(n.matrixWorldInverse));const r=[],o=e.children;for(let u=0,h=o.length;u<h;u++){const d=o[u];if(!Ss(d)||!d.__used)continue;d.cached.boundingVolume.intersectRay(s,Je)!==null&&(Je.applyMatrix4(n.matrixWorld),r.push({distance:Je.distanceToSquared(t.ray.origin),tile:d}))}r.sort(ws);let a=null,l=1/0;if(i.has(e)){const u=gr(e,t,c);u&&(a=u,l=u.distance*u.distance)}for(let u=0,h=r.length;u<h;u++){const d=r[u],f=d.distance,p=d.tile;if(f>l)break;const g=Rs(c,p,t,s);if(g){const m=g.distance*g.distance;m<l&&(a=g,l=m)}}return a}function Ls(c,e,t,s,n=null){if(!Ss(e))return;const{group:i,activeTiles:r}=c,{boundingVolume:o}=e.cached;if(n===null&&(n=xs,n.copy(t.ray).applyMatrix4(i.matrixWorldInverse)),!e.__used||!o.intersectsRay(n))return;r.has(e)&&Es(e,t,c,s);const a=e.children;for(let l=0,u=a.length;l<u;l++)Ls(c,a[l],t,s,n)}const Se=new S,Re=new S,N=new S,Le=new at;class kt{constructor(e=new rs,t=new C){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new C,this.points=new Array(8).fill().map(()=>new S),this.planes=new Array(6).fill().map(()=>new ln)}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return new this.constructor().copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,N).distanceTo(e)}containsPoint(e){return N.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(N)}intersectsRay(e){return Le.copy(e).applyMatrix4(this.inverseTransform),Le.intersectsBox(this.box)}intersectRay(e,t){return Le.copy(e).applyMatrix4(this.inverseTransform),Le.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:i,max:r}=n;let o=0;for(let a=-1;a<=1;a+=2)for(let l=-1;l<=1;l+=2)for(let u=-1;u<=1;u+=2)e[o].set(a<0?i.x:r.x,l<0?i.y:r.y,u<0?i.z:r.z).applyMatrix4(s),o++;this.updatePlanes()}updatePlanes(){Se.copy(this.box.min).applyMatrix4(this.transform),Re.copy(this.box.max).applyMatrix4(this.transform),N.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(N,Se),this.planes[1].setFromNormalAndCoplanarPoint(N,Re).negate(),N.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(N,Se),this.planes[3].setFromNormalAndCoplanarPoint(N,Re).negate(),N.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(N,Se),this.planes[5].setFromNormalAndCoplanarPoint(N,Re).negate()}intersectsSphere(e){return this.clampPoint(e.center,N),N.distanceToSquared(e.center)<=e.radius*e.radius}intersectsFrustum(e){return this._intersectsPlaneShape(e.planes,e.points)}intersectsOBB(e){return this._intersectsPlaneShape(e.planes,e.points)}_intersectsPlaneShape(e,t){const s=this.points,n=this.planes;for(let i=0;i<6;i++){const r=e[i];let o=-1/0;for(let a=0;a<8;a++){const l=s[a],u=r.distanceToPoint(l);o=o<u?u:o}if(o<0)return!1}for(let i=0;i<6;i++){const r=n[i];let o=-1/0;for(let a=0;a<8;a++){const l=t[a],u=r.distanceToPoint(l);o=o<u?u:o}if(o<0)return!1}return!0}}const X=Math.PI,Me=X/2,le=new S,ee=new S,te=new S,Vt=new C;let de=0;const Ze=[];function Tr(c=!1){return c?(Ze[de]||(Ze[de]=new S),de++,Ze[de-1]):new S}function Ht(){de=0}class _r extends As{constructor(e,t,s,n=-Me,i=Me,r=0,o=2*X,a=0,l=0){super(e,t,s),this.latStart=n,this.latEnd=i,this.lonStart=r,this.lonEnd=o,this.heightStart=a,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:s,lonStart:n,lonEnd:i,heightStart:r,heightEnd:o}=this,a=Q.mapLinear(.5,0,1,t,s),l=Q.mapLinear(.5,0,1,n,i),u=Math.floor(n/Me)*Me,h=[[-X/2,0],[X/2,0],[0,u],[0,u+X/2],[0,u+X],[0,u+3*X/2],[t,i],[s,i],[t,n],[s,n],[0,n],[0,i],[a,l],[t,l],[s,l],[a,n],[a,i]],d=[],f=h.length;for(let p=0;p<=1;p++){const g=Q.mapLinear(p,0,1,r,o);for(let m=0,_=f;m<_;m++){const[y,R]=h[m];if(y>=t&&y<=s&&R>=n&&R<=i){const b=Tr(e);d.push(b),this.getCartographicToPosition(y,R,g,b)}}}return d}getBoundingBox(e,t){Ht();const{latStart:s,latEnd:n,lonStart:i,lonEnd:r}=this;if(n-s<X/2){const l=Q.mapLinear(.5,0,1,s,n),u=Q.mapLinear(.5,0,1,i,r);this.getCartographicToNormal(l,u,te),ee.set(0,0,1),le.crossVectors(ee,te),ee.crossVectors(le,te),t.makeBasis(le,ee,te)}else le.set(1,0,0),ee.set(0,1,0),te.set(0,0,1),t.makeBasis(le,ee,te);Vt.copy(t).invert();const a=this._getPoints(!0);for(let l=0,u=a.length;l<u;l++)a[l].applyMatrix4(Vt);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){Ht();const s=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(s,t)}}const k=new S,V=new S,H=new S,Gt=new S,jt=new S;class yr{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let i=-1/0,r=-1/0;s&&e.intersectSphere(s,Gt)&&(i=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(Gt)),n&&n.intersectRay(e,jt)&&(r=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(jt));const o=Math.max(i,r);return o===-1/0?null:(e.at(Math.sqrt(o),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,i=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(i=s.distanceToPoint(e)),n>i?n:i}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}intersectsSphere(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!s.intersectsSphere(e)||t&&!t.intersectsSphere(e)?!1:!!(s||t)}intersectsOBB(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsOBB(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new kt;k.set(e[3],e[4],e[5]),V.set(e[6],e[7],e[8]),H.set(e[9],e[10],e[11]);const n=k.length(),i=V.length(),r=H.length();k.normalize(),V.normalize(),H.normalize(),n===0&&k.crossVectors(V,H),i===0&&V.crossVectors(k,H),r===0&&H.crossVectors(k,V),s.transform.set(k.x,V.x,H.x,e[0],k.y,V.y,H.y,e[1],k.z,V.z,H.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-i,-r),s.box.max.set(n,i,r),s.update(),this.obb=s}setSphereData(e,t,s,n,i){const r=new ot;r.center.set(e,t,s),r.radius=n,r.applyMatrix4(i),this.sphere=r}setRegionData(e,t,s,n,i,r,o){const a=new _r(...e.radius,s,i,t,n,r,o),l=new kt;a.getBoundingBox(l.box,l.transform),l.update(),this.region=a,this.regionObb=l}}const Ar=new hn;function br(c,e,t,s){const n=Ar.set(c.normal.x,c.normal.y,c.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-c.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class xr extends un{constructor(){super(),this.points=Array(8).fill().map(()=>new S)}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,i)=>{br(n[0],n[1],n[2],t[i])})}}function wr(c){const{TextureUtils:e}=dn;if(!e||!c)return 0;const{format:t,type:s,image:n}=c,{width:i,height:r}=n;let o=e.getByteLength(i,r,t,s);return o*=c.generateMipmaps?4/3:1,o}function Er(c){const e=new Set;let t=0;return c.traverse(s=>{if(s.geometry&&!e.has(s.geometry)&&(t+=Ln(s.geometry),e.add(s.geometry)),s.material){const n=s.material;for(const i in n){const r=n[i];r&&r.isTexture&&!e.has(r)&&(t+=wr(r),e.add(r))}}}),t}const zt=new C,Kt=new os,Ms=Symbol("INITIAL_FRUSTUM_CULLED"),Ce=new C,ue=new S,et=new ge,Pe={inView:!1,error:1/0},Sr=new S(1,0,0),Rr=new S(0,1,0);function qt(c,e){c.traverse(t=>{t.frustumCulled=t[Ms]&&e})}class Mr extends An{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{qt(t,!e)}))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new mr(this),this.ellipsoid=ve.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new C,this._bytesUsed=new WeakMap,this._autoDisableRendererCulling=!0;const t=new fn;t.setURLModifier(s=>this.preprocessURL?this.preprocessURL(s):s),this.manager=t,this._listeners={}}addEventListener(...e){Te.prototype.addEventListener.call(this,...e)}hasEventListener(...e){Te.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){Te.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){Te.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached&&t.cached.scene;s&&e(s,t)},null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=Rs(this,this.root,e);s&&t.push(s)}else Ls(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new ge),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const i=t.isVector2?t.x:t,r=t.isVector2?t.y:s,o=n.get(e);return(o.width!==i||o.height!==r)&&(o.set(i,r),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(et),this.setResolution(e,et.x,et.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileSet(...e){return super.loadRootTileSet(...e).then(t=>{const{asset:s,extensions:n={}}=t;switch((s&&s.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(Rr,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(Sr,Math.PI/2);break}if("3DTILES_ellipsoid"in n){const r=n["3DTILES_ellipsoid"],{ellipsoid:o}=this;o.name=r.body,r.radii?o.radius.set(...r.radii):o.radius.set(1,1,1)}return t})}update(){let e=null;if(this.invokeAllPlugins(r=>{if(r.doTilesNeedUpdate){const o=r.doTilesNeedUpdate();e===null?e=o:e=!!(e||o)}}),e===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,i=this.cameraInfo;for(;i.length>s.length;)i.pop();for(;i.length<s.length;)i.push({frustum:new xr,isOrthographic:!1,sseDenominator:-1,position:new S,invScale:-1,pixelSize:0});ue.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(ue.x-ue.y,ue.x-ue.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let r=0,o=i.length;r<o;r++){const a=s[r],l=i[r],u=l.frustum,h=l.position,d=n.get(a);(d.width===0||d.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const f=a.projectionMatrix.elements;if(l.isOrthographic=f[15]===1,l.isOrthographic){const p=2/f[0],g=2/f[5];l.pixelSize=Math.max(g/d.height,p/d.width)}else l.sseDenominator=2/f[5]/d.height;Ce.copy(t.matrixWorld),Ce.premultiply(a.matrixWorldInverse),Ce.premultiply(a.projectionMatrix),u.setFromProjectionMatrix(Ce),h.set(0,0,0),h.applyMatrix4(a.matrixWorld),h.applyMatrix4(t.matrixWorldInverse)}if(super.update(),this.dispatchEvent({type:"update-after"}),s.length===0&&this.root){let r=!1;this.invokeAllPlugins(o=>r=r||!!(o!==this&&o.calculateTileViewError)),r===!1&&console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new C;if(e.transform){const o=e.transform;for(let a=0;a<16;a++)n.elements[a]=o[a]}s&&n.premultiply(s.cached.transform);const i=new C().copy(n).invert(),r=new yr;"sphere"in e.boundingVolume&&r.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&r.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&r.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:i,active:!1,boundingVolume:r,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s,n,i){const r=t.cached,o=n.split(/[\\/]/g);o.pop();const a=o.join("/"),l=this.fetchOptions,u=this.manager;let h=null;const d=r.transform,f=this._upRotationMatrix,p=(ie(e)||s).toLowerCase();switch(p){case"b3dm":{const T=new _s(u);T.workingPath=a,T.fetchOptions=l,T.adjustmentTransform.copy(f),h=T.parse(e);break}case"pnts":{const T=new ys(u);T.workingPath=a,T.fetchOptions=l,h=T.parse(e);break}case"i3dm":{const T=new bs(u);T.workingPath=a,T.fetchOptions=l,T.adjustmentTransform.copy(f),T.ellipsoid.copy(this.ellipsoid),h=T.parse(e);break}case"cmpt":{const T=new pr(u);T.workingPath=a,T.fetchOptions=l,T.adjustmentTransform.copy(f),T.ellipsoid.copy(this.ellipsoid),h=T.parse(e).then(w=>w.scene);break}case"gltf":case"glb":{const T=u.getHandler("path.gltf")||u.getHandler("path.glb")||new ht(u);T.setWithCredentials(l.credentials==="include"),T.setRequestHeader(l.headers||{}),l.credentials==="include"&&l.mode==="cors"&&T.setCrossOrigin("use-credentials");let w=T.resourcePath||T.path||a;!/[\\/]$/.test(w)&&w.length&&(w+="/"),h=T.parseAsync(e,w).then(E=>{E.scene=E.scene||new ne;const{scene:x}=E;return x.updateMatrix(),x.matrix.multiply(f).decompose(x.position,x.quaternion,x.scale),E});break}default:{h=this.invokeOnePlugin(T=>T.parseToMesh&&T.parseToMesh(e,t,s,n,i));break}}const g=await h;if(g===null)throw new Error(`TilesRenderer: Content type "${p}" not supported.`);let m,_;g.isObject3D?(m=g,_=null):(m=g.scene,_=g),m.updateMatrix(),m.matrix.premultiply(d),m.matrix.decompose(m.position,m.quaternion,m.scale),await this.invokeAllPlugins(T=>T.processTileModel&&T.processTileModel(m,t)),m.traverse(T=>{T[Ms]=T.frustumCulled}),qt(m,!this.autoDisableRendererCulling);const y=[],R=[],b=[];if(m.traverse(T=>{if(T.geometry&&R.push(T.geometry),T.material){const w=T.material;y.push(T.material);for(const E in w){const x=w[E];x&&x.isTexture&&b.push(x)}}}),i.aborted){for(let T=0,w=b.length;T<w;T++){const E=b[T];E.image instanceof ImageBitmap&&E.image.close(),E.dispose()}return}r.materials=y,r.geometry=R,r.textures=b,r.scene=m,r.metadata=_}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,i=t.textures,r=t.scene.parent;t.scene.traverse(o=>{o.userData.meshFeatures&&o.userData.meshFeatures.dispose(),o.userData.structuralMetadata&&o.userData.structuralMetadata.dispose()});for(let o=0,a=n.length;o<a;o++)n[o].dispose();for(let o=0,a=s.length;o<a;o++)s[o].dispose();for(let o=0,a=i.length;o<a;o++){const l=i[o];l.image instanceof ImageBitmap&&l.image.close(),l.dispose()}r&&r.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateBytesUsed(e,t){const s=this._bytesUsed;return!s.has(e)&&t&&s.set(e,Er(t)),s.get(e)??null}calculateTileViewError(e,t){const s=e.cached,n=this.cameras,i=this.cameraInfo,r=s.boundingVolume;let o=!1,a=-1/0,l=1/0,u=-1/0,h=1/0;for(let d=0,f=n.length;d<f;d++){const p=i[d];let g,m;if(p.isOrthographic){const y=p.pixelSize;g=e.geometricError/y,m=1/0}else{const y=p.sseDenominator;m=r.distanceToPoint(p.position),g=m===0?1/0:e.geometricError/(m*y)}const _=i[d].frustum;r.intersectsFrustum(_)&&(o=!0,a=Math.max(a,g),l=Math.min(l,m)),u=Math.max(u,g),h=Math.min(h,m)}this.invokeAllPlugins(d=>{d!==this&&d.calculateTileViewError&&(d.calculateTileViewError(e,Pe),Pe.inView&&(o=!0,a=Math.max(a,Pe.error)),u=Math.max(u,Pe.error))}),o?(t.inView=!0,t.error=a,t.distanceFromCamera=l):(t.inView=!1,t.error=u,t.distanceFromCamera=h)}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:n}=this;Kt.set(Math.PI/2,Math.PI/2,0),zt.makeRotationFromEuler(Kt),s.getEastNorthUpFrame(e,t,0,n.matrix).multiply(zt).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}export{Mr as T};
